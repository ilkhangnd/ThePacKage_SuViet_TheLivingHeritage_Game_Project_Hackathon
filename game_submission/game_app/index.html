<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sử Việt – The Living Heritage</title>
    <style>
      :root {
        --primary: #e2a946;
        --secondary: #931c19;
        --accent: #e8d4a3;
        --danger: #52221f;
        --light: #f5f5f5;
        --dark: #2f191b;
        --text: #333333;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, var(--dark) 0%, #52221f 100%);
        color: var(--text);
        min-height: 100vh;
        overflow-x: hidden;
      }

      .screen {
        display: none;
        animation: fadeIn 0.5s ease;
      }

      .active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        text-align: center;
        padding: 20px 0;
        background: rgba(47, 25, 27, 0.9);
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
      }

      header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
            circle at 20% 30%,
            rgba(232, 212, 163, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 70%,
            rgba(226, 169, 70, 0.1) 0%,
            transparent 50%
          );
        z-index: 0;
      }

      h1 {
        color: var(--accent);
        font-size: 2.8rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        position: relative;
        z-index: 1;
      }

      .subtitle {
        color: var(--light);
        font-size: 1.3rem;
        margin-bottom: 15px;
        position: relative;
        z-index: 1;
      }

      #login-screen {
        text-align: center;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin-top: 20px;
      }

      .login-content {
        position: relative;
        z-index: 1;
        max-width: 500px;
        margin: 0 auto;
      }

      .login-form {
        background: rgba(226, 169, 70, 0.1);
        padding: 25px;
        border-radius: 15px;
        margin: 20px 0;
        text-align: left;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: var(--primary);
      }

      .form-group input {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .form-group input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(226, 169, 70, 0.2);
      }

      #menu-screen,
      #impact-screen,
      #summary-screen {
        text-align: center;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin-top: 20px;
      }

      #menu-screen::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.03"><path d="M30,30 L50,10 L70,30 L70,50 L50,70 L30,50 Z" fill="%232F191B"/></svg>'),
          url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.03"><circle cx="50" cy="50" r="30" fill="%23931C19"/></svg>');
        background-size: 100px 100px, 80px 80px;
        background-position: 10% 20%, 90% 80%;
        z-index: 0;
      }

      .menu-content {
        position: relative;
        z-index: 1;
      }

      .problem-statement {
        background: rgba(147, 28, 25, 0.1);
        border-left: 4px solid var(--secondary);
        padding: 20px;
        margin: 25px 0;
        text-align: left;
        border-radius: 0 12px 12px 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .problem-statement h3 {
        color: var(--secondary);
        margin-bottom: 12px;
        font-size: 1.4rem;
      }

      .stats {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 15px;
        margin: 20px 0;
      }

      .stat-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        flex: 1;
        min-width: 150px;
        text-align: center;
      }

      .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--primary);
        margin-bottom: 5px;
      }

      .btn {
        padding: 16px 32px;
        font-size: 1.2rem;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 10px;
        position: relative;
        overflow: hidden;
        white-space: nowrap;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        transition: left 0.5s;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn-primary {
        background: var(--primary);
        color: var(--dark);
        box-shadow: 0 6px 0 var(--dark);
      }

      .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 9px 0 var(--dark);
      }

      .btn-primary:active {
        transform: translateY(3px);
        box-shadow: 0 3px 0 var(--dark);
      }

      .btn-secondary {
        background: var(--secondary);
        color: white;
        box-shadow: 0 6px 0 #52221f;
      }

      .btn-secondary:hover {
        transform: translateY(-3px);
        box-shadow: 0 9px 0 #52221f;
      }

      .btn-secondary:active {
        transform: translateY(3px);
        box-shadow: 0 3px 0 #52221f;
      }

      .menu-buttons {
        margin-top: 30px;
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 20px;
      }

      #game-screen {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        flex: 1;
        display: flex;
        flex-direction: column;
        margin-top: 20px;
      }

      .game-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--primary);
        flex-wrap: wrap;
        gap: 15px;
      }

      .player-stats {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .stat {
        background: var(--primary);
        color: var(--dark);
        padding: 12px 18px;
        border-radius: 10px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .era-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 20px 0;
        background: rgba(226, 169, 70, 0.1);
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .era-card {
        text-align: center;
        padding: 15px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
        margin: 0 5px;
        position: relative;
        overflow: hidden;
        min-width: 80px;
      }

      .era-card.active {
        background: var(--primary);
        color: var(--dark);
        transform: scale(1.05);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      }

      .era-card.locked {
        opacity: 0.6;
        cursor: not-allowed;
        background: #e0e0e0;
      }

      .era-icon {
        font-size: 2rem;
        margin-bottom: 5px;
      }

      .era-name {
        font-size: 0.8rem;
      }

      .game-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
        flex: 1;
      }

      @media (max-width: 768px) {
        .game-content {
          grid-template-columns: 1fr;
        }

        .era-card {
          margin: 0 3px;
          padding: 10px;
        }
      }

      .content-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }

      .content-card h3 {
        color: var(--primary);
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--accent);
      }

      .task-progress {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: bold;
        color: var(--primary);
      }

      .era-info {
        flex: 1;
        overflow-y: auto;
        max-height: 300px;
      }

      .heritage-item {
        background: rgba(226, 169, 70, 0.1);
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid var(--primary);
      }

      .quiz-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 15px;
      }

      .quiz-option {
        padding: 12px 15px;
        background: #f0f0f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
      }

      .quiz-option:hover {
        background: #e0e0e0;
        transform: translateX(5px);
      }

      .quiz-option.correct {
        background: #4caf50 !important;
        color: white;
      }

      .quiz-option.incorrect {
        background: #f44336 !important;
        color: white;
      }

      .quiz-option.answered {
        pointer-events: none;
        opacity: 0.8;
      }

      .puzzle-area {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
      }

      .puzzle-source,
      .puzzle-target {
        min-height: 150px;
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .puzzle-target {
        background: rgba(226, 169, 70, 0.05);
      }

      .puzzle-piece {
        background: var(--secondary);
        color: white;
        padding: 10px 15px;
        border-radius: 6px;
        cursor: move;
        user-select: none;
        text-align: center;
        transition: all 0.2s ease;
      }

      .puzzle-piece.dragging {
        opacity: 0.7;
        transform: scale(1.05);
      }

      .puzzle-piece.correct {
        background: #4caf50 !important;
      }

      .puzzle-piece.incorrect {
        background: #f44336 !important;
      }

      .ai-assistant {
        grid-column: 1 / -1;
        margin-top: 20px;
      }

      .chat-container {
        height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        background: #f9f9f9;
      }

      .message {
        margin-bottom: 12px;
        padding: 10px 15px;
        border-radius: 10px;
        max-width: 80%;
        animation: messageAppear 0.3s ease;
      }

      @keyframes messageAppear {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .user-message {
        background: #e3f2fd;
        margin-left: auto;
      }

      .ai-message {
        background: #f5f5f5;
      }

      .chat-input {
        display: flex;
        gap: 10px;
      }

      .chat-input input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 25px;
        font-size: 1rem;
      }

      #impact-screen {
        text-align: center;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .impact-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin: 30px 0;
      }

      @media (max-width: 768px) {
        .impact-grid {
          grid-template-columns: 1fr;
        }
      }

      .impact-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: all 0.3s ease;
      }

      .impact-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
      }

      .impact-icon {
        font-size: 3rem;
        margin-bottom: 15px;
      }

      .impact-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--primary);
        margin: 10px 0;
      }

      .progress-ring {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 20px;
      }

      .progress-bg,
      .progress-fill {
        fill: none;
        stroke-width: 8;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
      }

      .progress-bg {
        stroke: #e0e0e0;
      }

      .progress-fill {
        stroke: var(--primary);
        stroke-dasharray: 314;
        stroke-dashoffset: 314;
        transition: stroke-dashoffset 1s ease;
      }

      .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary);
      }

      #summary-screen h2 {
        color: var(--primary);
        font-size: 2rem;
        margin-bottom: 20px;
      }

      #preserved-list {
        list-style-type: "🌟 ";
        padding-left: 0;
      }

      #preserved-list li {
        background: var(--light);
        border-radius: 8px;
        padding: 10px 15px;
        margin-bottom: 8px;
        border-left: 5px solid var(--accent);
        text-align: left;
      }

      footer {
        text-align: center;
        margin-top: 30px;
        color: white;
        font-size: 0.9rem;
        opacity: 0.8;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateX(150%);
        transition: transform 0.3s ease;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        border-left: 4px solid #4caf50;
      }

      .notification.error {
        border-left: 4px solid #f44336;
      }

      .notification.warning {
        border-left: 4px solid var(--secondary);
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div id="notification" class="notification">
        <span id="notification-icon">ℹ️</span>
        <span id="notification-text">Thông báo</span>
      </div>

      <section id="login-screen" class="screen active">
        <header
          style="
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: -40px -40px 30px -40px;
            border-radius: 20px 20px 0 0;
          "
        >
          <img
            src="/game_submission/game_fig/su-viet.png"
            alt="fig"
            style="max-width: 1000px; margin-top: 20px"
          />
          <p
            class="subtitle"
            style="margin-bottom: 10px; font-size: 1.5rem; font-weight: 500"
          >
            Giữ gìn bản sắc, văn hóa Việt
          </p>
        </header>

        <div class="login-content">
          <h2>Người bảo vệ Di sản</h2>
          <p>
            Vui lòng nhập họ và tên của bạn để bắt đầu hành trình bảo vệ di sản
            văn hóa Việt Nam.
          </p>

          <div class="login-form">
            <div class="form-group">
              <label for="player-name">Họ và Tên:</label>
              <input
                type="text"
                id="player-name"
                placeholder="Nhập họ và tên của bạn"
                required
              />
            </div>
            <button
              class="btn btn-primary"
              id="login-btn"
              style="display: block; margin: 0 auto"
            >
              Bắt đầu hành trình
            </button>
          </div>

          <div
            class="history-section"
            style="margin-top: 30px; display: none"
            id="history-section"
          >
            <h3>Lịch sử tham gia</h3>
            <div
              id="history-list"
              style="
                text-align: left;
                background: rgba(255, 255, 255, 0.8);
                padding: 15px;
                border-radius: 10px;
                max-height: 200px;
                overflow-y: auto;
              "
            ></div>
          </div>
        </div>
      </section>

      <!-- Trang hoạt động chính -->
      <section id="main-screen" class="screen">
        <section id="menu-screen" class="screen active">
          <header>
            <h1>THE LIVING HERITAGE</h1>
            <p class="subtitle">Bảo vệ Văn hóa Việt - Chống lại sự lãng quên</p>
          </header>

          <div class="menu-content">
            <h2>Chào mừng <span id="player-greeting"></span>!</h2>
            <p>
              Di sản văn hóa Việt Nam đang bị đe dọa bởi sự lãng quên. Hãy cùng
              chúng tôi hồi sinh những giá trị quý báu!
            </p>

            <div class="problem-statement">
              <h3>VẤN ĐỀ XÃ HỘI: Mất kết nối với di sản văn hóa</h3>
              <p>
                Theo khảo sát, hơn 60% giới trẻ Việt Nam không biết về các di
                sản văn hóa địa phương. Kiến thức lịch sử đang dần bị lãng quên,
                đe dọa đến bản sắc văn hóa dân tộc.
              </p>
            </div>

            <div class="stats">
              <div class="stat-card">
                <div class="stat-value">67%</div>
                <div class="stat-label">Giới trẻ thiếu kiến thức lịch sử</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">42%</div>
                <div class="stat-label">Di sản đang bị đe dọa</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">58%</div>
                <div class="stat-label">
                  Không quan tâm đến văn hóa truyền thống
                </div>
              </div>
            </div>

            <div class="menu-buttons">
              <button class="btn btn-primary" id="start-btn">
                Bắt Đầu Hành Trình
              </button>
              <button class="btn btn-secondary" id="impact-btn">
                Xem Tác Động
              </button>
              <button class="btn btn-secondary" id="logout-btn">
                Đăng Xuất
              </button>
            </div>
          </div>
        </section>

        <section id="game-screen" class="screen">
          <div class="game-header">
            <h2 id="era-title">Thời Kỳ Vua Hùng</h2>
            <div class="player-stats">
              <div class="stat">
                <span>🪙</span>
                <span id="score">100</span>
              </div>
              <div class="stat">
                <span>🏛️</span>
                <span id="heritage-count">0/6</span>
              </div>
              <div class="stat">
                <span>📚</span>
                <span id="knowledge">0%</span>
              </div>
              <button class="btn btn-secondary" id="back-btn">Quay Lại</button>
            </div>
          </div>

          <div class="era-navigation">
            <div class="era-card active" data-era="hungVuong">
              <div class="era-icon">👑</div>
              <div class="era-name">Vua Hùng</div>
            </div>
            <div class="era-card locked" data-era="bachDang">
              <div class="era-icon">⚔️</div>
              <div class="era-name">Ngô Quyền</div>
            </div>
            <div class="era-card locked" data-era="ly">
              <div class="era-icon">🏯</div>
              <div class="era-name">Nhà Lý</div>
            </div>
            <div class="era-card locked" data-era="tran">
              <div class="era-icon">🛡️</div>
              <div class="era-name">Nhà Trần</div>
            </div>
            <div class="era-card locked" data-era="le">
              <div class="era-icon">⚖️</div>
              <div class="era-name">Nhà Lê</div>
            </div>
            <div class="era-card locked" data-era="modern">
              <div class="era-icon">🌏</div>
              <div class="era-name">Hiện Đại</div>
            </div>
          </div>

          <div class="game-content">
            <div class="content-card">
              <h3>Thông Tin Thời Kỳ</h3>
              <div class="era-info" id="era-info"></div>
              <button
                class="btn btn-primary"
                id="preserve-btn"
                style="margin-top: 15px"
              >
                Bảo Vệ Di Sản
              </button>
            </div>

            <div class="content-card">
              <h3>Kiểm Tra Kiến Thức (Quiz)</h3>
              <div class="task-progress" id="quiz-progress">
                Tiến độ: 0/3 câu đúng (Yêu cầu: 70%)
              </div>
              <div class="quiz-question" id="quiz-question"></div>
              <div class="quiz-options" id="quiz-options"></div>
              <div
                id="quiz-feedback"
                style="margin-top: 15px; font-weight: bold"
              ></div>
              <button
                class="btn btn-secondary"
                id="next-quiz-btn"
                style="margin-top: 10px; display: none"
              >
                Câu Tiếp Theo
              </button>
            </div>

            <div class="content-card">
              <h3>Ghép Mảnh Lịch Sử (Puzzle)</h3>
              <div class="task-progress" id="puzzle-progress">
                Tiến độ: 0/2 nhiệm vụ (Yêu cầu: 70%)
              </div>
              <div id="puzzle-instruction"></div>
              <div class="puzzle-area">
                <div class="puzzle-source" id="puzzle-source"></div>
                <div class="puzzle-target" id="puzzle-target">
                  <div class="placeholder">Kéo các sự kiện vào đây</div>
                </div>
              </div>
              <button
                class="btn btn-primary"
                id="check-puzzle"
                style="margin-top: 15px"
              >
                Kiểm Tra
              </button>
              <div
                id="puzzle-feedback"
                style="margin-top: 15px; font-weight: bold"
              ></div>
            </div>

            <div class="content-card ai-assistant">
              <h3>Trợ Lý Di Sản AI</h3>
              <div class="chat-container" id="chat-container">
                <div class="message ai-message">
                  Xin chào! Tôi là trợ lý di sản AI. Tôi có thể giúp gì cho bạn
                  trong hành trình bảo vệ văn hóa Việt Nam?
                </div>
              </div>
              <div class="chat-input">
                <input
                  type="text"
                  id="user-input"
                  placeholder="Nhập câu hỏi của bạn về lịch sử..."
                />
                <button class="btn btn-primary" id="send-btn">Gửi</button>
              </div>
            </div>
          </div>
        </section>

        <section id="impact-screen" class="screen">
          <header>
            <h1>TÁC ĐỘNG XÃ HỘI</h1>
            <p class="subtitle">
              Những đóng góp của bạn tạo ra sự thay đổi tích cực
            </p>
          </header>

          <div class="impact-grid">
            <div class="impact-card">
              <div class="progress-ring">
                <svg width="120" height="120" viewBox="0 0 120 120">
                  <circle class="progress-bg" cx="60" cy="60" r="50"></circle>
                  <circle
                    class="progress-fill"
                    cx="60"
                    cy="60"
                    r="50"
                    id="impact-knowledge-ring"
                  ></circle>
                </svg>
                <div class="progress-text" id="impact-knowledge-text">0%</div>
              </div>
              <h3>Kiến thức được khôi phục</h3>
              <p>Lượng kiến thức lịch sử được lan tỏa trong cộng đồng</p>
            </div>

            <div class="impact-card">
              <div class="progress-ring">
                <svg width="120" height="120" viewBox="0 0 120 120">
                  <circle class="progress-bg" cx="60" cy="60" r="50"></circle>
                  <circle
                    class="progress-fill"
                    cx="60"
                    cy="60"
                    r="50"
                    id="impact-heritage-ring"
                  ></circle>
                </svg>
                <div class="progress-text" id="impact-heritage-text">0%</div>
              </div>
              <h3>Di sản được bảo vệ</h3>
              <p>Số di sản văn hóa được bảo tồn cho thế hệ tương lai</p>
            </div>

            <div class="impact-card">
              <div class="progress-ring">
                <svg width="120" height="120" viewBox="0 0 120 120">
                  <circle class="progress-bg" cx="60" cy="60" r="50"></circle>
                  <circle
                    class="progress-fill"
                    cx="60"
                    cy="60"
                    r="50"
                    id="impact-youth-ring"
                  ></circle>
                </svg>
                <div class="progress-text" id="impact-youth-text">0%</div>
              </div>
              <h3>Giới trẻ quan tâm</h3>
              <p>Tỷ lệ giới trẻ quan tâm đến lịch sử và di sản văn hóa</p>
            </div>

            <div class="impact-card">
              <div class="progress-ring">
                <svg width="120" height="120" viewBox="0 0 120 120">
                  <circle class="progress-bg" cx="60" cy="60" r="50"></circle>
                  <circle
                    class="progress-fill"
                    cx="60"
                    cy="60"
                    r="50"
                    id="impact-awareness-ring"
                  ></circle>
                </svg>
                <div class="progress-text" id="impact-awareness-text">0%</div>
              </div>
              <h3>Nhận thức cộng đồng</h3>
              <p>Mức độ nhận thức về giá trị di sản trong cộng đồng</p>
            </div>
          </div>

          <div style="margin-top: 30px">
            <button class="btn btn-primary" id="back-from-impact">
              Quay Lại
            </button>
          </div>
        </section>

        <section id="summary-screen" class="screen">
          <header>
            <h1>HOÀN THÀNH HÀNH TRÌNH!</h1>
            <p class="subtitle">Bạn đã trở thành Người Bảo Vệ Di Sản vĩ đại!</p>
          </header>

          <div class="menu-content">
            <h2>KẾT QUẢ TỔNG KẾT</h2>
            <p>
              Xin chúc mừng <span id="player-summary-name"></span>! Bạn đã hoàn
              thành hành trình qua các thời kỳ lịch sử Việt Nam và bảo vệ thành
              công các di sản quý giá.
            </p>

            <div class="stats" id="summary-stats-general">
              <div class="stat-card">
                <div class="stat-value" id="final-score">0</div>
                <div class="stat-label">Tổng Điểm Di Sản</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="final-heritage-count">0/6</div>
                <div class="stat-label">Di Sản Đã Bảo Vệ</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="final-knowledge">0%</div>
                <div class="stat-label">Kiến Thức Tổng Thể</div>
              </div>
            </div>

            <h3>Danh Sách Di Sản Được Bảo Vệ:</h3>
            <ul
              id="preserved-list"
              style="
                text-align: left;
                list-style-type: '🌟 ';
                margin: 20px auto;
                max-width: 600px;
                padding-left: 20px;
              "
            ></ul>

            <div style="margin-top: 30px">
              <button class="btn btn-primary" id="restart-btn">Chơi Lại</button>
              <button class="btn btn-secondary" id="back-to-menu-summary">
                Về Menu
              </button>
            </div>
          </div>
        </section>
      </section>

      <footer>
        <p>© 2025 SỬ VIỆT - THE LIVING HERITAGE</p>
      </footer>
    </div>

    <script>
      // Game State Management
      const gameState = {
        playerName: "",
        score: 100,
        heritageCount: 0,
        knowledge: 0,
        currentEra: "hungVuong",
        unlockedEras: ["hungVuong"],
        preservedHeritages: [],
        taskProgress: {
          hungVuong: { quizCorrect: 0, puzzleCompleted: 0 },
          bachDang: { quizCorrect: 0, puzzleCompleted: 0 },
          ly: { quizCorrect: 0, puzzleCompleted: 0 },
          tran: { quizCorrect: 0, puzzleCompleted: 0 },
          le: { quizCorrect: 0, puzzleCompleted: 0 },
          modern: { quizCorrect: 0, puzzleCompleted: 0 },
        },
        quizCurrentIndex: 0,
        puzzleCurrentIndex: 0,
        socialImpact: {
          knowledgeRestored: 0,
          heritagePreserved: 0,
          youthEngagement: 0,
          culturalAwareness: 0,
        },
      };

      // CONSTANTS
      const QUIZ_PASS_RATE = 0.7; // 70%
      const PUZZLE_PASS_RATE = 0.7; // 70%

      // Era Data with Enhanced Content and Multi-Quiz/Puzzle
      const eraData = {
        hungVuong: {
          title: "Thời Kỳ Vua Hùng",
          info: `
                    <p><strong>Thời gian:</strong> Khoảng thế kỷ VII TCN - thế kỷ III TCN. Đây là thời kỳ hình thành nhà nước Văn Lang, mở đầu cho lịch sử dân tộc Việt Nam.</p>
                    <p><strong>Nhà nước:</strong> Văn Lang - nhà nước đầu tiên của người Việt với 18 đời Vua Hùng trị vì. Tổ chức xã hội đơn giản, dựa trên các công xã nông thôn (chiềng, chạ).</p>
                    <div class="heritage-item">
                        <strong>Di sản:</strong> Trống đồng Đông Sơn
                        <p>Biểu tượng của nền văn minh lúa nước, với hoa văn tinh xảo thể hiện đời sống văn hóa, tín ngưỡng (nhảy múa, giã gạo) và kỹ thuật luyện kim đồng thau của người Việt cổ.</p>
                    </div>
                    <div class="heritage-item">
                        <strong>Di sản:</strong> Truyền thuyết Con Rồng Cháu Tiên
                        <p>Huyền thoại về nguồn gốc dân tộc (Lạc Long Quân - Âu Cơ), thể hiện tinh thần đoàn kết và niềm tự hào về nòi giống Tiên Rồng.</p>
                    </div>
                `,
          quizs: [
            // 3 Quiz questions
            {
              question:
                "Nhà nước đầu tiên trong lịch sử Việt Nam có tên là gì?",
              options: [
                { text: "Văn Lang", correct: true },
                { text: "Âu Lạc", correct: false },
                { text: "Đại Việt", correct: false },
              ],
            },
            {
              question: "Văn minh Đông Sơn nổi tiếng với loại hình di sản nào?",
              options: [
                { text: "Chùa Một Cột", correct: false },
                { text: "Trống đồng", correct: true },
                { text: "Kiến trúc đá", correct: false },
              ],
            },
            {
              question:
                "Truyền thuyết nào nói về nguồn gốc của dân tộc Việt Nam?",
              options: [
                { text: "Sơn Tinh Thủy Tinh", correct: false },
                { text: "Bánh chưng, bánh giầy", correct: false },
                { text: "Con Rồng Cháu Tiên", correct: true },
              ],
            },
          ],
          puzzles: [
            // 2 Puzzle missions
            {
              instruction: "Sắp xếp thứ tự các mốc chính:",
              pieces: [
                { text: "Thành lập nước Văn Lang", order: 1 },
                { text: "18 đời Vua Hùng", order: 2 },
                { text: "Phát triển trống đồng Đông Sơn", order: 3 },
              ],
            },
            {
              instruction: "Sắp xếp theo ý nghĩa tượng trưng:",
              pieces: [
                { text: "Bánh chưng (Đất)", order: 1 },
                { text: "Bánh giầy (Trời)", order: 2 },
                { text: "Truyền ngôi cho Lang Liêu", order: 3 },
              ],
            },
          ],
        },
        bachDang: {
          title: "Ngô Quyền và Chiến thắng Bạch Đằng",
          info: `
                    <p><strong>Thời gian:</strong> Năm 938. Đây là trận chiến mang tính bước ngoặt, chấm dứt hơn 1000 năm Bắc thuộc.</p>
                    <p><strong>Sự kiện:</strong> Chiến thắng Bạch Đằng chống quân Nam Hán dưới sự lãnh đạo của Ngô Quyền, người sau đó xưng vương, mở ra thời kỳ độc lập tự chủ lâu dài.</p>
                    <div class="heritage-item">
                        <strong>Di sản:</strong> Chiến thuật cọc Bạch Đằng
                        <p>Trận địa cọc ngầm được đóng ở cửa sông Bạch Đằng, lợi dụng thủy triều lên xuống để đánh bại thủy quân Nam Hán. Đây là một sáng tạo quân sự vĩ đại.</p>
                    </div>
                    <div class="heritage-item">
                        <strong>Di sản:</strong> Tinh thần độc lập dân tộc
                        <p>Chiến thắng năm 938 khẳng định ý chí độc lập tự chủ, mở ra kỷ nguyên phong kiến trung ương tập quyền của Việt Nam.</p>
                    </div>
                `,
          quizs: [
            {
              question:
                "Trận Bạch Đằng do Ngô Quyền lãnh đạo diễn ra vào năm nào?",
              options: [
                { text: "Năm 938", correct: true },
                { text: "Năm 939", correct: false },
                { text: "Năm 940", correct: false },
              ],
            },
            {
              question:
                "Mục đích chính của việc đóng cọc trên sông Bạch Đằng là gì?",
              options: [
                { text: "Chặn đường tiến quân", correct: false },
                {
                  text: "Lợi dụng thủy triều để đâm thuyền giặc",
                  correct: true,
                },
                { text: "Để thuyền ta neo đậu", correct: false },
              ],
            },
            {
              question:
                "Chiến thắng Bạch Đằng có ý nghĩa gì đối với lịch sử Việt Nam?",
              options: [
                { text: "Chấm dứt hoàn toàn ách Bắc thuộc", correct: true },
                { text: "Mở ra nhà nước phong kiến đầu tiên", correct: false },
                { text: "Bảo vệ Văn Lang", correct: false },
              ],
            },
          ],
          puzzles: [
            {
              instruction: "Sắp xếp các bước chuẩn bị chiến đấu:",
              pieces: [
                { text: "Ngô Quyền tập hợp lực lượng", order: 1 },
                { text: "Đóng cọc trên sông Bạch Đằng", order: 2 },
                { text: "Dụ địch vào trận địa", order: 3 },
              ],
            },
            {
              instruction: "Sắp xếp theo thời gian:",
              pieces: [
                { text: "Ngô Quyền xưng Vương", order: 1 },
                { text: "Đánh bại quân Nam Hán", order: 2 },
                { text: "Thiết lập triều đình", order: 3 },
              ],
            },
          ],
        },
        ly: {
          title: "Nhà Lý và Kinh đô Thăng Long",
          info: `
                    <p><strong>Thời gian:</strong> 1009 - 1225. Đây là triều đại mở đầu cho thời kỳ độc lập, tự chủ và xây dựng văn hóa rực rỡ của Việt Nam.</p>
                    <p><strong>Kinh đô:</strong> Thăng Long (Hà Nội ngày nay). Vua Lý Thái Tổ (Lý Công Uẩn) dời đô từ Hoa Lư về Đại La, đổi tên là Thăng Long (Rồng bay lên) vào năm 1010.</p>
                    <div class="heritage-item">
                        <strong>Di sản:</strong> Chùa Một Cột
                        <p>Được xây dựng năm 1049, là biểu tượng của Phật giáo Việt Nam dưới thời Lý. Kiến trúc độc đáo hình bông sen nở trên cột đá, thể hiện sự sáng tạo trong kiến trúc tôn giáo.</p>
                    </div>
                    <div class="heritage-item">
                        <strong>Di sản:</strong> Văn Miếu - Quốc Tử Giám
                        <p>Được xây dựng năm 1070 (Văn Miếu) và 1076 (Quốc Tử Giám - trường đại học đầu tiên). Đây là biểu tượng của truyền thống hiếu học và trọng nhân tài của dân tộc.</p>
                    </div>
                `,
          quizs: [
            {
              question:
                "Ai là người sáng lập ra nhà Lý và dời đô về Thăng Long?",
              options: [
                { text: "Lý Công Uẩn", correct: true },
                { text: "Lý Thánh Tông", correct: false },
                { text: "Lý Nhân Tông", correct: false },
              ],
            },
            {
              question: "Văn Miếu được xây dựng vào năm nào?",
              options: [
                { text: "Năm 1010", correct: false },
                { text: "Năm 1070", correct: true },
                { text: "Năm 1076", correct: false },
              ],
            },
            {
              question: "Ý nghĩa của việc đặt tên kinh đô là Thăng Long?",
              options: [
                { text: "Địa điểm quân sự chiến lược", correct: false },
                {
                  text: "Tượng trưng cho vận nước 'Rồng bay lên'",
                  correct: true,
                },
                { text: "Nơi có nhiều sông hồ", correct: false },
              ],
            },
          ],
          puzzles: [
            {
              instruction: "Sắp xếp các mốc thời gian:",
              pieces: [
                { text: "Lý Công Uẩn lên ngôi", order: 1 },
                { text: "Dời đô về Thăng Long (1010)", order: 2 },
                { text: "Thành lập Quốc Tử Giám (1076)", order: 3 },
              ],
            },
            {
              instruction: "Sắp xếp theo mối liên hệ:",
              pieces: [
                { text: "Phật giáo phát triển", order: 1 },
                { text: "Xây chùa Một Cột", order: 2 },
                { text: "Trọng dụng nhân tài", order: 3 },
              ],
            },
          ],
        },
        tran: {
          title: "Nhà Trần và Hào khí Đông A",
          info: `
                    <p><strong>Thời gian:</strong> 1225 - 1400. Nổi tiếng với chiến công ba lần đánh bại quân Nguyên Mông hùng mạnh, giữ vững nền độc lập dân tộc.</p>
                    <p><strong>Sự kiện:</strong> Hội nghị Diên Hồng (1284) với sự tham gia của các bô lão, thể hiện ý chí "Vua tôi đồng lòng, anh em hòa thuận" chống giặc. Hưng Đạo Vương Trần Quốc Tuấn là vị tướng tài ba nhất.</p>
                    <div class="heritage-item">
                        <strong>Di sản:</strong> Tinh thần Đông A (Hào khí Đông A)
                        <p>Chữ Hán của họ Trần (陳) được tách thành hai chữ Đông (東) và A (阿). "Hào khí Đông A" biểu trưng cho ý chí đoàn kết, lòng yêu nước và sức mạnh của triều đại nhà Trần trong lịch sử chống Nguyên Mông.</p>
                    </div>
                    <div class="heritage-item">
                        <strong>Di sản:</strong> Thiền phái Trúc Lâm Yên Tử
                        <p>Do vua Trần Nhân Tông sáng lập, là dòng Thiền mang đậm bản sắc Việt, đánh dấu sự phát triển độc lập, tự chủ của Phật giáo Việt Nam, không còn chịu ảnh hưởng của các nước lân cận.</p>
                    </div>
                `,
          quizs: [
            {
              question:
                "Danh tướng nào gắn liền với câu nói nổi tiếng 'Sát Thát' và lãnh đạo quân đội đánh bại Nguyên Mông?",
              options: [
                { text: "Trần Hưng Đạo", correct: true },
                { text: "Trần Thủ Độ", correct: false },
                { text: "Trần Quang Khải", correct: false },
              ],
            },
            {
              question: "Hội nghị Diên Hồng có sự tham gia của ai?",
              options: [
                { text: "Các đại thần", correct: false },
                { text: "Các bô lão", correct: true },
                { text: "Tất cả quan lại", correct: false },
              ],
            },
            {
              question:
                "Thiền phái Trúc Lâm Yên Tử được thành lập bởi vị vua nào?",
              options: [
                { text: "Trần Thái Tông", correct: false },
                { text: "Trần Nhân Tông", correct: true },
                { text: "Trần Anh Tông", correct: false },
              ],
            },
          ],
          puzzles: [
            {
              instruction: "Sắp xếp thứ tự các mốc triều đại:",
              pieces: [
                { text: "Trần Cảnh lên ngôi", order: 1 },
                { text: "Chiến thắng Nguyên Mông lần 1 (1258)", order: 2 },
                { text: "Hội nghị Diên Hồng (1284)", order: 3 },
              ],
            },
            {
              instruction: "Sắp xếp theo mối liên hệ:",
              pieces: [
                { text: "Phật giáo phát triển", order: 1 },
                { text: "Ra đời Thiền phái Trúc Lâm", order: 2 },
                { text: "Trần Nhân Tông đi tu", order: 3 },
              ],
            },
          ],
        },
        le: {
          title: "Nhà Lê Sơ và Cải cách Hồng Đức",
          info: `
                    <p><strong>Thời gian:</strong> 1428 - 1789 (Thời kỳ Lê Sơ: 1428-1527). Thời kỳ đỉnh cao của chế độ phong kiến Việt Nam, bắt đầu từ Lê Thái Tổ (Lê Lợi).</p>
                    <p><strong>Vua tiêu biểu:</strong> Lê Thánh Tông (trị vì 1460-1497) với các cuộc cải cách toàn diện về hành chính, kinh tế, giáo dục và pháp luật, đưa đất nước phát triển cực thịnh.</p>
                    <div class="heritage-item">
                        <strong>Di sản:</strong> Bộ luật Hồng Đức (Quốc triều hình luật)
                        <p>Bộ luật hoàn chỉnh và tiến bộ nhất trong lịch sử phong kiến Việt Nam. Đáng chú ý là bảo vệ quyền lợi phụ nữ và nông dân, thể hiện tư tưởng pháp trị của nhà nước.</p>
                    </div>
                    <div class="heritage-item">
                        <strong>Di sản:</strong> Bia Tiến sĩ tại Văn Miếu
                        <p>Tiếp tục truyền thống trọng học, Nhà Lê Sơ tổ chức nhiều khoa thi. Việc dựng Bia Tiến sĩ (từ năm 1484) là để ghi danh các nhân tài, khuyến khích học tập.</p>
                    </div>
                `,
          quizs: [
            {
              question:
                "Ai là người đã giải phóng đất nước khỏi ách đô hộ của nhà Minh, lập ra Nhà Lê Sơ?",
              options: [
                { text: "Lê Thánh Tông", correct: false },
                { text: "Lê Lợi (Lê Thái Tổ)", correct: true },
                { text: "Nguyễn Trãi", correct: false },
              ],
            },
            {
              question:
                "Bộ luật tiêu biểu nhất dưới thời Nhà Lê Sơ, bảo vệ quyền lợi phụ nữ là gì?",
              options: [
                { text: "Bộ luật Hình sự", correct: false },
                { text: "Bộ luật Hồng Đức", correct: true },
                { text: "Hoàng triều luật lệ", correct: false },
              ],
            },
            {
              question:
                "Vua nào đã thực hiện nhiều cải cách và đưa đất nước phát triển cực thịnh thời Lê Sơ?",
              options: [
                { text: "Lê Thái Tổ", correct: false },
                { text: "Lê Thánh Tông", correct: true },
                { text: "Lê Nhân Tông", correct: false },
              ],
            },
          ],
          puzzles: [
            {
              instruction: "Sắp xếp các mốc lịch sử:",
              pieces: [
                { text: "Khởi nghĩa Lam Sơn", order: 1 },
                { text: "Lê Lợi đăng quang", order: 2 },
                { text: "Đánh bại quân Minh", order: 3 },
              ],
            },
            {
              instruction: "Sắp xếp theo mối liên hệ:",
              pieces: [
                { text: "Đề cao giáo dục", order: 1 },
                { text: "Tổ chức khoa thi", order: 2 },
                { text: "Dựng Bia Tiến sĩ (1484)", order: 3 },
              ],
            },
          ],
        },
        modern: {
          title: "Thời Kỳ Hiện Đại (Thế kỷ XX - Nay)",
          info: `
                    <p><strong>Thời gian:</strong> 1945 - Hiện tại. Giai đoạn giành độc lập, thống nhất đất nước và hội nhập quốc tế.</p>
                    <p><strong>Sự kiện:</strong> Cách mạng tháng Tám 1945 và Tuyên ngôn độc lập, mở ra kỷ nguyên mới cho dân tộc. Đỉnh cao là Chiến dịch Hồ Chí Minh lịch sử năm 1975, thống nhất đất nước.</p>
                    <div class="heritage-item">
                        <strong>Di sản:</strong> Khu di tích Hoàng thành Thăng Long
                        <p>Khu di tích lịch sử và văn hóa quan trọng, là minh chứng cho sự phát triển liên tục của kinh đô Việt Nam qua nhiều triều đại (Lý, Trần, Lê, Nguyễn). Được UNESCO công nhận Di sản Thế giới năm 2010.</p>
                    </div>
                    <div class="heritage-item">
                        <strong>Di sản:</strong> Tinh thần Yêu nước và Độc lập Dân tộc
                        <p>Giá trị cốt lõi được hun đúc qua các cuộc kháng chiến, thể hiện qua các hiện vật lịch sử, nghệ thuật đương đại và ý thức bảo tồn văn hóa trong thời kỳ hội nhập.</p>
                    </div>
                `,
          quizs: [
            {
              question:
                "Hoàng thành Thăng Long được UNESCO công nhận là Di sản Thế giới vào năm nào?",
              options: [
                { text: "Năm 2010", correct: true },
                { text: "Năm 2000", correct: false },
                { text: "Năm 2011", correct: false },
              ],
            },
            {
              question:
                "Sự kiện nào đánh dấu sự chấm dứt hoàn toàn chế độ phong kiến tại Việt Nam?",
              options: [
                { text: "Chiến dịch Điện Biên Phủ", correct: false },
                { text: "Cách mạng tháng Tám (1945)", correct: true },
                { text: "Hiệp định Geneva", correct: false },
              ],
            },
            {
              question:
                "Địa danh nào là biểu tượng cho sự kiện giải phóng miền Nam, thống nhất đất nước năm 1975?",
              options: [
                { text: "Dinh Độc Lập", correct: true },
                { text: "Khu Phố Cổ Hội An", correct: false },
                { text: "Địa đạo Củ Chi", correct: false },
              ],
            },
          ],
          puzzles: [
            {
              instruction: "Sắp xếp thứ tự các mốc lịch sử:",
              pieces: [
                { text: "Cách mạng tháng Tám (1945)", order: 1 },
                { text: "Chiến thắng Điện Biên Phủ (1954)", order: 2 },
                { text: "Thống nhất đất nước (1975)", order: 3 },
              ],
            },
            {
              instruction: "Sắp xếp theo mối liên hệ:",
              pieces: [
                { text: "Hội nhập Quốc tế", order: 1 },
                { text: "Phát huy Văn hóa truyền thống", order: 2 },
                { text: "Di sản Thế giới", order: 3 },
              ],
            },
          ],
        },
      };

      // AI Responses
      const aiResponses = {
        greetings: [
          "Xin chào Người Bảo Vệ Di Sản! Tôi có thể giúp gì cho bạn trong hành trình bảo vệ văn hóa Việt Nam?",
          "Chào bạn! Cùng nhau, chúng ta có thể bảo vệ di sản văn hóa Việt Nam khỏi sự lãng quên.",
          "Xin chào! Hãy hỏi tôi bất cứ điều gì về lịch sử và di sản Việt Nam.",
        ],
        hungVuong: [
          "Thời đại Hùng Vương là thời kỳ mở đầu cho lịch sử Việt Nam, kéo dài từ khoảng thế kỷ VII TCN đến thế kỷ III TCN.",
          "Theo truyền thuyết, 18 đời Vua Hùng đã cai trị nước Văn Lang - nhà nước đầu tiên của người Việt.",
          "Thời kỳ Hùng Vương gắn liền với nền văn hóa Đông Sơn nổi tiếng với trống đồng và các công cụ bằng đồng.",
        ],
        bachDang: [
          "Ngô Quyền là vị anh hùng dân tộc đã lãnh đạo chiến thắng Bạch Đằng năm 938, chấm dứt hơn 1000 năm Bắc thuộc.",
          "Trận Bạch Đằng năm 938 là một trong những chiến thắng vĩ đại nhất trong lịch sử chống ngoại xâm của dân tộc Việt Nam.",
          "Ngô Quyền đã dùng kế cắm cọc nhọn trên sông Bạch Đằng để đánh bại quân Nam Hán.",
        ],
        ly: [
          "Lý Công Uẩn là người sáng lập ra Nhà Lý và đã dời đô từ Hoa Lư về Thăng Long (Hà Nội ngày nay) vào năm 1010.",
          "Văn Miếu - Quốc Tử Giám được xây dựng dưới thời Lý, là trường đại học đầu tiên của Việt Nam.",
          "Nhà Lý đã mở ra một thời kỳ độc lập, tự chủ và phát triển văn hóa rực rỡ cho dân tộc.",
        ],
        tran: [
          "Nhà Trần nổi tiếng với ba lần kháng chiến chống quân Nguyên Mông thắng lợi, dưới sự lãnh đạo của Hưng Đạo Vương Trần Quốc Tuấn.",
          "Thiền phái Trúc Lâm Yên Tử ra đời dưới thời Trần, thể hiện sự phát triển độc lập của Phật giáo Việt Nam.",
          "Hội nghị Diên Hồng là biểu tượng cho sự đồng lòng 'vua tôi đồng lòng, anh em hòa thuận' chống ngoại xâm.",
        ],
        le: [
          "Lê Lợi là người đã giải phóng đất nước khỏi ách đô hộ nhà Minh, lập ra Nhà Lê Sơ.",
          "Vua Lê Thánh Tông là người đã ban hành Bộ luật Hồng Đức, bộ luật tiến bộ và toàn diện nhất trong lịch sử phong kiến Việt Nam.",
          "Truyền thống hiếu học được đề cao qua việc dựng Bia Tiến sĩ tại Văn Miếu.",
        ],
        heritage: [
          "Bảo vệ di sản không chỉ là gìn giữ quá khứ, mà là xây dựng tương lai từ những giá trị cốt lõi của dân tộc.",
          "Mỗi di sản được bảo vệ là một câu chuyện được kể lại, một giá trị được truyền trao cho thế hệ tương lai.",
          "Khi giới trẻ quan tâm đến di sản, họ không chỉ học về lịch sử mà còn tìm thấy bản sắc và niềm tự hào dân tộc.",
        ],
        general: [
          "Lịch sử Việt Nam trải qua hàng ngàn năm với nhiều thăng trầm nhưng luôn giữ vững tinh thần độc lập dân tộc.",
          "Dân tộc Việt Nam có truyền thống yêu nước, bất khuất chống ngoại xâm và xây dựng đất nước.",
          "Văn hóa Việt Nam là sự kết hợp hài hòa giữa bản sắc dân tộc và tiếp thu tinh hoa văn hóa nhân loại.",
        ],
      };

      // DOM Elements
      const screens = document.querySelectorAll(".screen");
      const loginScreen = document.getElementById("login-screen");
      const menuScreen = document.getElementById("menu-screen");
      const gameScreen = document.getElementById("game-screen");
      const impactScreen = document.getElementById("impact-screen");
      const summaryScreen = document.getElementById("summary-screen");

      const loginBtn = document.getElementById("login-btn");
      const startBtn = document.getElementById("start-btn");
      const impactBtn = document.getElementById("impact-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const backBtn = document.getElementById("back-btn");
      const backFromImpactBtn = document.getElementById("back-from-impact");
      const restartBtn = document.getElementById("restart-btn");
      const backToMenuSummary = document.getElementById("back-to-menu-summary");

      const playerNameInput = document.getElementById("player-name");
      const playerGreeting = document.getElementById("player-greeting");
      const playerSummaryName = document.getElementById("player-summary-name");
      const historySection = document.getElementById("history-section");
      const historyList = document.getElementById("history-list");

      const eraTitle = document.getElementById("era-title");
      const scoreElement = document.getElementById("score");
      const heritageCountElement = document.getElementById("heritage-count");
      const knowledgeElement = document.getElementById("knowledge");
      const eraInfo = document.getElementById("era-info");

      // Quiz Elements
      const quizQuestion = document.getElementById("quiz-question");
      const quizOptions = document.getElementById("quiz-options");
      const quizFeedback = document.getElementById("quiz-feedback");
      const nextQuizBtn = document.getElementById("next-quiz-btn");
      const quizProgress = document.getElementById("quiz-progress");

      // Puzzle Elements
      const preserveBtn = document.getElementById("preserve-btn");
      const puzzleSource = document.getElementById("puzzle-source");
      const puzzleTarget = document.getElementById("puzzle-target");
      const checkPuzzleBtn = document.getElementById("check-puzzle");
      const puzzleFeedback = document.getElementById("puzzle-feedback");
      const puzzleInstruction = document.getElementById("puzzle-instruction");
      const puzzleProgress = document.getElementById("puzzle-progress");

      // AI Elements
      const chatContainer = document.getElementById("chat-container");
      const userInput = document.getElementById("user-input");
      const sendBtn = document.getElementById("send-btn");

      const eraCards = document.querySelectorAll(".era-card");

      // Impact Elements
      const impactKnowledgeRing = document.getElementById(
        "impact-knowledge-ring"
      );
      const impactHeritageRing = document.getElementById(
        "impact-heritage-ring"
      );
      const impactYouthRing = document.getElementById("impact-youth-ring");
      const impactAwarenessRing = document.getElementById(
        "impact-awareness-ring"
      );
      const impactKnowledgeText = document.getElementById(
        "impact-knowledge-text"
      );
      const impactHeritageText = document.getElementById(
        "impact-heritage-text"
      );
      const impactYouthText = document.getElementById("impact-youth-text");
      const impactAwarenessText = document.getElementById(
        "impact-awareness-text"
      );

      // Summary Elements
      const finalScore = document.getElementById("final-score");
      const finalHeritageCount = document.getElementById(
        "final-heritage-count"
      );
      const finalKnowledge = document.getElementById("final-knowledge");
      const preservedList = document.getElementById("preserved-list");

      const notification = document.getElementById("notification");
      const notificationIcon = document.getElementById("notification-icon");
      const notificationText = document.getElementById("notification-text");

      // Game Initialization
      function initGame() {
        updateGameState();
        loadEra(gameState.currentEra);
        setupEventListeners();
        loadPlayerHistory();
      }

      // Event Listeners Setup
      function setupEventListeners() {
        loginBtn.onclick = handleLogin;
        startBtn.onclick = () => showScreen("game-screen");
        impactBtn.onclick = () =>
          document
            .getElementById("impact-screen")
            .scrollIntoView({ behavior: "smooth" });
        logoutBtn.onclick = handleLogout;

        backBtn.onclick = () =>
          document
            .getElementById("menu-screen")
            .scrollIntoView({ behavior: "smooth" });
        backFromImpactBtn.onclick = () =>
          document
            .getElementById("menu-screen")
            .scrollIntoView({ behavior: "smooth" });
        restartBtn.onclick = resetGame;
        backToMenuSummary.onclick = () =>
          document
            .getElementById("menu-screen")
            .scrollIntoView({ behavior: "smooth" });

        preserveBtn.onclick = preserveHeritage;
        checkPuzzleBtn.onclick = checkPuzzle;
        nextQuizBtn.onclick = nextQuiz;
        sendBtn.onclick = sendMessage;
        userInput.onkeypress = (e) => {
          if (e.key === "Enter") sendMessage();
        };

        eraCards.forEach((card) => {
          card.onclick = function () {
            const eraId = this.getAttribute("data-era");
            if (gameState.unlockedEras.includes(eraId)) {
              loadEra(eraId);
            } else {
              showNotification(
                "Bạn cần hoàn thành thời kỳ trước để mở khóa!",
                "warning"
              );
            }
          };
        });
      }

      // Login/Logout Functions
      function handleLogin() {
        const playerName = playerNameInput.value.trim();

        if (!playerName) {
          showNotification("Vui lòng nhập họ và tên của bạn!", "error");
          return;
        }

        gameState.playerName = playerName;
        playerGreeting.textContent = playerName;
        playerSummaryName.textContent = playerName;

        showScreen("main-screen");
        showNotification(
          `Chào mừng ${playerName} đến với hành trình bảo vệ di sản!`,
          "success"
        );
      }

      function handleLogout() {
        savePlayerHistory();
        gameState.playerName = "";
        playerNameInput.value = "";
        showScreen("login-screen");
        showNotification("Đã đăng xuất thành công!", "success");
      }

      // Player History Management
      function savePlayerHistory() {
        if (!gameState.playerName) return;

        const playerHistory = {
          name: gameState.playerName,
          score: gameState.score,
          heritageCount: gameState.heritageCount,
          date: new Date().toLocaleDateString("vi-VN"),
          time: new Date().toLocaleTimeString("vi-VN"),
        };

        let history = JSON.parse(localStorage.getItem("playerHistory") || "[]");

        // Check if this player already has a history entry
        const existingIndex = history.findIndex(
          (entry) => entry.name === gameState.playerName
        );

        if (existingIndex !== -1) {
          // Update existing entry if current score is higher
          if (gameState.score > history[existingIndex].score) {
            history[existingIndex] = playerHistory;
          }
        } else {
          // Add new entry
          history.push(playerHistory);
        }

        // Keep only the last 10 entries
        if (history.length > 10) {
          history = history.slice(-10);
        }

        localStorage.setItem("playerHistory", JSON.stringify(history));
      }

      function loadPlayerHistory() {
        const history = JSON.parse(
          localStorage.getItem("playerHistory") || "[]"
        );

        if (history.length > 0) {
          historySection.style.display = "block";
          historyList.innerHTML = "";

          history.reverse().forEach((entry) => {
            const historyItem = document.createElement("div");
            historyItem.className = "heritage-item";
            historyItem.innerHTML = `
                        <strong>${entry.name}</strong> - ${entry.score} điểm - ${entry.heritageCount}/6 di sản<br>
                        <small>${entry.date} ${entry.time}</small>
                    `;
            historyList.appendChild(historyItem);
          });
        } else {
          historySection.style.display = "none";
        }
      }

      // Screen Management
      function showScreen(screenId) {
        screens.forEach((screen) => {
          screen.classList.remove("active");
        });

        if (screenId === "main-screen") {
          document.getElementById("main-screen").classList.add("active");
          document.getElementById("menu-screen").classList.add("active");
        } else if (
          screenId === "game-screen" ||
          screenId === "impact-screen" ||
          screenId === "summary-screen"
        ) {
          document.getElementById("main-screen").classList.add("active");
          document.getElementById(screenId).classList.add("active");
        } else {
          document.getElementById(screenId).classList.add("active");
        }

        if (screenId === "impact-screen") {
          updateImpactScreen();
        }
      }

      // Era Management
      function loadEra(eraId) {
        gameState.currentEra = eraId;
        const eraProgress = gameState.taskProgress[eraId];

        const era = eraData[eraId];
        eraTitle.textContent = era.title;
        eraInfo.innerHTML = era.info;

        // Update active/locked era cards
        eraCards.forEach((card) => {
          const cardEraId = card.getAttribute("data-era");
          if (cardEraId === eraId) {
            card.classList.add("active");
          } else {
            card.classList.remove("active");
          }

          if (!gameState.unlockedEras.includes(cardEraId)) {
            card.classList.add("locked");
          } else {
            card.classList.remove("locked");
          }
        });

        // Load tasks
        loadQuizTask(eraId);
        loadPuzzleTask(eraId);

        // Update preserve button
        updatePreserveButton();
      }

      // --- QUIZ LOGIC ---

      function loadQuizTask(eraId) {
        const era = eraData[eraId];
        const progress = gameState.taskProgress[eraId];
        const maxQuiz = era.quizs.length;
        const currentQuizCorrect = progress.quizCorrect;

        // Get current quiz index for display/loading
        const nextQuizIndex = currentQuizCorrect % maxQuiz;

        const minQuizCorrect = Math.ceil(maxQuiz * QUIZ_PASS_RATE);

        quizProgress.textContent = `Tiến độ: ${currentQuizCorrect}/${maxQuiz} câu đúng (Yêu cầu: ${minQuizCorrect} câu)`;

        if (currentQuizCorrect >= minQuizCorrect) {
          quizQuestion.textContent =
            "✅ ĐÃ HOÀN THÀNH: Bạn đã đạt điểm để bảo vệ Di sản!";
          quizOptions.innerHTML = "";
          quizFeedback.textContent = "";
          nextQuizBtn.style.display = "none";
          return;
        }

        const quiz = era.quizs[nextQuizIndex];

        quizQuestion.textContent = `Câu hỏi ${nextQuizIndex + 1}/${maxQuiz}: ${
          quiz.question
        }`;
        quizOptions.innerHTML = "";
        quizFeedback.textContent = "Chọn câu trả lời của bạn:";
        nextQuizBtn.style.display = "none";

        quiz.options.forEach((option) => {
          const optionElement = document.createElement("div");
          optionElement.className = "quiz-option";
          optionElement.textContent = option.text;
          optionElement.setAttribute("data-correct", option.correct);

          optionElement.addEventListener("click", () =>
            checkAnswer(optionElement)
          );
          quizOptions.appendChild(optionElement);
        });
      }

      function checkAnswer(selectedOption) {
        // Check if any option is already selected/answered for this question
        if (quizOptions.querySelector(".answered")) return;

        const isCorrect =
          selectedOption.getAttribute("data-correct") === "true";
        const eraId = gameState.currentEra;

        // Mark all options as answered (disable click)
        quizOptions
          .querySelectorAll(".quiz-option")
          .forEach((opt) => opt.classList.add("answered"));

        if (isCorrect) {
          selectedOption.classList.add("correct");
          quizFeedback.textContent = "Chính xác! +10 điểm.";
          quizFeedback.style.color = "green";

          gameState.score += 10;
          gameState.socialImpact.knowledgeRestored += 5;
          gameState.knowledge += 5;

          // Increase correct count, capping at max questions
          gameState.taskProgress[eraId].quizCorrect = Math.min(
            eraData[eraId].quizs.length,
            gameState.taskProgress[eraId].quizCorrect + 1
          );
          showNotification(
            "Chính xác! Kiến thức lịch sử được khôi phục",
            "success"
          );
        } else {
          selectedOption.classList.add("incorrect");
          quizFeedback.textContent = "Chưa chính xác. Hãy học lại và thử lại!";
          quizFeedback.style.color = "red";

          const correctOption = quizOptions.querySelector(
            '.quiz-option[data-correct="true"]'
          );
          correctOption.classList.add("correct");

          showNotification("Hãy học lại và thử lại!", "error");
        }

        // Display next button if not already completed
        const maxQuiz = eraData[eraId].quizs.length;
        const minQuizCorrect = Math.ceil(maxQuiz * QUIZ_PASS_RATE);
        if (gameState.taskProgress[eraId].quizCorrect < minQuizCorrect) {
          nextQuizBtn.style.display = "block";
        }

        updateGameState();
        updatePreserveButton();
      }

      function nextQuiz() {
        const eraId = gameState.currentEra;
        const currentEraData = eraData[eraId];
        const progress = gameState.taskProgress[eraId];

        // Reload the task, which automatically loads the next question based on current progress
        loadQuizTask(eraId);
      }

      // --- PUZZLE LOGIC ---

      function loadPuzzleTask(eraId) {
        const era = eraData[eraId];
        const progress = gameState.taskProgress[eraId];
        const maxPuzzle = era.puzzles.length;
        const currentPuzzleCompleted = progress.puzzleCompleted;

        const minPuzzleCompleted = Math.ceil(maxPuzzle * PUZZLE_PASS_RATE);

        puzzleProgress.textContent = `Tiến độ: ${currentPuzzleCompleted}/${maxPuzzle} nhiệm vụ (Yêu cầu: ${minPuzzleCompleted} nhiệm vụ)`;
        checkPuzzleBtn.disabled = false;

        if (currentPuzzleCompleted >= minPuzzleCompleted) {
          puzzleInstruction.innerHTML =
            "✅ ĐÃ HOÀN THÀNH: Bạn đã đạt điểm để bảo vệ Di sản!";
          puzzleFeedback.textContent = "";
          puzzleSource.innerHTML = "";
          puzzleTarget.innerHTML = "";
          checkPuzzleBtn.disabled = true;
          return;
        }

        const index = currentPuzzleCompleted % maxPuzzle;
        const puzzle = era.puzzles[index];

        puzzleInstruction.innerHTML = `<p><strong>Nhiệm vụ ${
          currentPuzzleCompleted + 1
        }/${maxPuzzle}:</strong> ${puzzle.instruction}</p>`;
        puzzleSource.innerHTML = "";
        puzzleTarget.innerHTML =
          '<div class="placeholder">Kéo các sự kiện vào đây</div>';
        puzzleFeedback.textContent =
          "Sắp xếp các mảnh ghép vào khung bên trái.";

        // Shuffle and load pieces
        const shuffledPieces = [...puzzle.pieces].sort(
          () => Math.random() - 0.5
        );
        shuffledPieces.forEach((piece) => {
          puzzleSource.appendChild(createPuzzlePiece(piece));
        });

        // Set up drag/drop listeners
        setupDropZone();
      }

      function checkPuzzle() {
        const eraId = gameState.currentEra;
        const era = eraData[eraId];
        const currentPuzzleIndex =
          gameState.taskProgress[eraId].puzzleCompleted % era.puzzles.length;

        const piecesInTarget = Array.from(
          puzzleTarget.querySelectorAll(".puzzle-piece")
        );
        const totalPieces = era.puzzles[currentPuzzleIndex].pieces.length;

        // Reset piece visuals
        piecesInTarget.forEach((p) =>
          p.classList.remove("correct", "incorrect")
        );

        if (piecesInTarget.length < totalPieces) {
          puzzleFeedback.textContent = `Hãy kéo đủ ${totalPieces} sự kiện vào khung!`;
          puzzleFeedback.style.color = "red";
          return;
        }

        let correct = true;

        piecesInTarget.forEach((piece, index) => {
          const pieceOrder = parseInt(piece.getAttribute("data-order"));
          const expectedOrder = index + 1;

          // Remove previous feedback classes
          piece.classList.remove("correct", "incorrect");

          if (pieceOrder === expectedOrder) {
            piece.classList.add("correct");
          } else {
            piece.classList.add("incorrect");
            correct = false;
          }
        });

        if (correct) {
          puzzleFeedback.textContent =
            "Hoàn hảo! +15 điểm. Bạn đã hoàn thành nhiệm vụ này.";
          puzzleFeedback.style.color = "green";

          gameState.score += 15;
          gameState.socialImpact.knowledgeRestored += 8;
          gameState.knowledge += 8;

          // Advance puzzle progress and reload next puzzle
          gameState.taskProgress[eraId].puzzleCompleted++;
          loadPuzzleTask(eraId);

          showNotification("Xuất sắc! Bạn đã sắp xếp đúng lịch sử", "success");
        } else {
          puzzleFeedback.textContent =
            "Thứ tự chưa chính xác. Hãy sắp xếp lại!";
          puzzleFeedback.style.color = "red";

          // Re-enable dragging for all pieces in target for re-arranging
          piecesInTarget.forEach((p) => p.setAttribute("draggable", "true"));
        }

        updateGameState();
        updatePreserveButton();
      }

      // Helper functions for Puzzle (createPiece, setupDropZone, handleDrop)
      function createPuzzlePiece(piece) {
        const pieceElement = document.createElement("div");
        pieceElement.className = "puzzle-piece";
        pieceElement.textContent = piece.text;
        pieceElement.setAttribute("draggable", "true");
        pieceElement.setAttribute("data-order", piece.order);

        pieceElement.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", piece.order);
          pieceElement.classList.add("dragging");
        });

        pieceElement.addEventListener("dragend", () => {
          pieceElement.classList.remove("dragging");
        });
        return pieceElement;
      }

      function setupDropZone() {
        // Remove old listeners to prevent duplication
        puzzleTarget.removeEventListener("dragover", preventDefault);
        puzzleTarget.removeEventListener("drop", handleTargetDrop);
        puzzleSource.removeEventListener("dragover", preventDefault);
        puzzleSource.removeEventListener("drop", handleSourceDrop);

        // Add new listeners
        puzzleTarget.addEventListener("dragover", preventDefault);
        puzzleTarget.addEventListener("drop", handleTargetDrop);
        puzzleSource.addEventListener("dragover", preventDefault);
        puzzleSource.addEventListener("drop", handleSourceDrop);
      }

      function preventDefault(e) {
        e.preventDefault();
      }

      function handleTargetDrop(e) {
        e.preventDefault();
        const order = e.dataTransfer.getData("text/plain");
        const piece = document.querySelector(
          `.puzzle-piece[data-order="${order}"]`
        );

        if (piece && piece.parentElement !== puzzleTarget) {
          // Ensure correct piece style/dragability is maintained for re-ordering
          piece.classList.remove("correct", "incorrect");
          piece.setAttribute("draggable", "true");
          puzzleTarget.appendChild(piece);
          const placeholder = puzzleTarget.querySelector(".placeholder");
          if (placeholder) placeholder.remove();
        }
      }

      function handleSourceDrop(e) {
        e.preventDefault();
        const order = e.dataTransfer.getData("text/plain");
        const piece = document.querySelector(
          `.puzzle-piece[data-order="${order}"]`
        );

        if (piece && piece.parentElement !== puzzleSource) {
          piece.classList.remove("correct", "incorrect"); // Reset visual
          puzzleSource.appendChild(piece);
          if (puzzleTarget.children.length === 0) {
            puzzleTarget.innerHTML =
              '<div class="placeholder">Kéo các sự kiện vào đây</div>';
          }
        }
      }

      // --- GLOBAL MECHANICS ---

      function checkEraCompletion() {
        const eraId = gameState.currentEra;
        const eraDataCurrent = eraData[eraId];
        const progress = gameState.taskProgress[eraId];

        const minQuizCorrect = Math.ceil(
          eraDataCurrent.quizs.length * QUIZ_PASS_RATE
        );
        const minPuzzleCompleted = Math.ceil(
          eraDataCurrent.puzzles.length * PUZZLE_PASS_RATE
        );

        const isQuizComplete = progress.quizCorrect >= minQuizCorrect;
        const isPuzzleComplete = progress.puzzleCompleted >= minPuzzleCompleted;

        return isQuizComplete && isPuzzleComplete;
      }

      function preserveHeritage() {
        const currentEra = gameState.currentEra;

        if (!checkEraCompletion()) {
          showNotification(
            "Bạn cần hoàn thành ít nhất 70% các nhiệm vụ (Quiz và Puzzle) trước khi bảo vệ di sản!",
            "warning"
          );
          return;
        }

        if (!gameState.preservedHeritages.includes(currentEra)) {
          gameState.preservedHeritages.push(currentEra);
          gameState.heritageCount = gameState.preservedHeritages.length;
          gameState.score += 20;
          gameState.socialImpact.heritagePreserved += 15;
          gameState.socialImpact.culturalAwareness += 10;
          gameState.socialImpact.youthEngagement += 5;

          updatePreserveButton();
          updateGameState();

          showNotification(
            `Di sản ${eraData[currentEra].title} đã được bảo vệ!`,
            "success"
          );
          unlockNextEra();
        }
      }

      function updatePreserveButton() {
        const isEraComplete = checkEraCompletion();
        const isPreserved = gameState.preservedHeritages.includes(
          gameState.currentEra
        );

        if (isPreserved) {
          preserveBtn.textContent = "Đã Bảo Vệ ✅";
          preserveBtn.disabled = true;
          preserveBtn.style.background = "#4CAF50";
          preserveBtn.style.boxShadow = "0 3px 0 #1B5E20";
        } else if (isEraComplete) {
          preserveBtn.textContent = "BẢO VỆ DI SẢN (Đủ điều kiện)";
          preserveBtn.disabled = false;
          // Sử dụng lại màu Primary và Dark (đã được định nghĩa bằng biến CSS)
          preserveBtn.style.background = getComputedStyle(
            document.documentElement
          )
            .getPropertyValue("--primary")
            .trim();
          preserveBtn.style.boxShadow =
            "0 6px 0 " +
            getComputedStyle(document.documentElement)
              .getPropertyValue("--dark")
              .trim();
        } else {
          preserveBtn.textContent = `Bảo Vệ Di Sản (Thiếu nhiệm vụ)`;
          preserveBtn.disabled = true;
          preserveBtn.style.background = "#9E9E9E";
          preserveBtn.style.boxShadow = "0 3px 0 #616161";
        }
      }

      function unlockNextEra() {
        const eras = Object.keys(eraData);
        const currentIndex = eras.indexOf(gameState.currentEra);

        if (gameState.preservedHeritages.length === eras.length) {
          savePlayerHistory();
          showSummaryScreen();
          return;
        }

        if (currentIndex < eras.length - 1) {
          const nextEra = eras[currentIndex + 1];
          if (!gameState.unlockedEras.includes(nextEra)) {
            gameState.unlockedEras.push(nextEra);

            eraCards.forEach((card) => {
              if (card.getAttribute("data-era") === nextEra) {
                card.classList.remove("locked");
              }
            });

            showNotification(
              `Chúc mừng! Bạn đã mở khóa: ${eraData[nextEra].title}. Hãy chuyển sang thời kỳ mới.`,
              "success"
            );
            loadEra(nextEra);
          }
        }
      }

      // --- AI Chat System ---

      // --- AI Chat System ---

      // Cấu hình API cho Azure OpenAI
      const AI_CONFIG = {
        apiKey:
          "EOd81yMG8zL8My7IRsBuBT9Z3iBMkL51KBTJ4xba6l5MWYguNnHBJQQJ99BJACYeBjFXJ3w3AAABACOGb1Yy",
        apiUrl:
          "https://rmit-hackathon-ve.openai.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-02-15-preview",
        deploymentName: "gpt-35-turbo", // Tên deployment model của bạn
        apiVersion: "2024-02-15-preview",
      };

      async function sendMessage() {
        const message = userInput.value.trim();
        if (message === "") return;

        addMessageToChat(message, "user");
        userInput.value = "";

        // Disable input while processing
        userInput.disabled = true;
        sendBtn.disabled = true;

        // Hiển thị indicator đang gõ
        const typingIndicator = addTypingIndicator();

        try {
          const aiResponse = await getAIResponse(message);
          removeTypingIndicator(typingIndicator);
          addMessageToChat(aiResponse, "ai");

          gameState.socialImpact.culturalAwareness += 1;
          updateGameState();
        } catch (error) {
          removeTypingIndicator(typingIndicator);
          console.error("AI Response Error:", error);
          // Fallback to local responses if API fails
          const fallbackResponse = generateAIResponse(message);
          addMessageToChat(fallbackResponse, "ai");
        } finally {
          // Re-enable input
          userInput.disabled = false;
          sendBtn.disabled = false;
          userInput.focus();
        }
      }

      async function getAIResponse(userMessage) {
        const currentEraId = gameState.currentEra;
        const currentEraData = eraData[currentEraId];

        // Tạo context cho AI về thời kỳ hiện tại
        const context = `Bạn là trợ lý AI chuyên về lịch sử và di sản văn hóa Việt Nam. 
Người dùng đang tìm hiểu về ${currentEraData.title}.

Thông tin về thời kỳ này:
${currentEraData.info.replace(/<[^>]*>/g, "")}

Hãy trả lời câu hỏi của người dùng một cách ngắn gọn, dễ hiểu và liên quan đến di sản văn hóa Việt Nam.
Sử dụng tiếng Việt và giữ câu trả lời trong khoảng 1-2 câu.`;

        const requestBody = {
          messages: [
            {
              role: "system",
              content: context,
            },
            {
              role: "user",
              content: userMessage,
            },
          ],
          max_tokens: 150,
          temperature: 0.7,
          top_p: 0.9,
          frequency_penalty: 0,
          presence_penalty: 0,
        };

        const response = await fetch(AI_CONFIG.apiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "api-key": AI_CONFIG.apiKey, // Azure sử dụng "api-key" thay vì "Authorization"
          },
          body: JSON.stringify(requestBody),
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error("API Error Details:", errorText);
          throw new Error(`API Error: ${response.status} - ${errorText}`);
        }

        const data = await response.json();

        if (data.choices && data.choices.length > 0) {
          return data.choices[0].message.content.trim();
        } else {
          throw new Error("No response from AI");
        }
      }

      function addTypingIndicator() {
        const typingElement = document.createElement("div");
        typingElement.className = "message ai-message typing-indicator";
        typingElement.innerHTML = `
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        `;
        chatContainer.appendChild(typingElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return typingElement;
      }

      function removeTypingIndicator(indicator) {
        if (indicator && indicator.parentNode) {
          indicator.parentNode.removeChild(indicator);
        }
      }

      function addMessageToChat(message, sender) {
        const messageElement = document.createElement("div");
        messageElement.className = `message ${sender}-message`;
        messageElement.textContent = message;
        chatContainer.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // Giữ lại hàm generateAIResponse như fallback
      function generateAIResponse(userMessage) {
        const lowerMessage = userMessage.toLowerCase();
        const currentEraId = gameState.currentEra;
        const currentEraData = eraData[currentEraId];

        if (
          lowerMessage.includes(currentEraData.title.toLowerCase()) ||
          lowerMessage.includes(currentEraId.toLowerCase()) ||
          lowerMessage.includes("thời kỳ này") ||
          lowerMessage.includes("di sản hiện tại")
        ) {
          const heritageItems = currentEraData.info.match(
            /<strong>Di sản:<\/strong>(.*?)<p>/g
          );
          let response = `Thời kỳ ${currentEraData.title} có nhiều di sản quan trọng. Nổi bật là: `;
          if (heritageItems) {
            response += heritageItems.map((m) =>
              m
                .replace(/<\/?strong>Di sản:<\/strong>/g, "")
                .replace(/<p>/g, "")
                .trim()
            )[0];
            if (heritageItems.length > 1) {
              response += ` và ${
                heritageItems.map((m) =>
                  m
                    .replace(/<\/?strong>Di sản:<\/strong>/g, "")
                    .replace(/<p>/g, "")
                    .trim()
                )[1]
              }.`;
            } else {
              response += `.`;
            }
          } else {
            response += `Bạn có thể tìm hiểu chi tiết hơn trong phần "Thông Tin Thời Kỳ".`;
          }
          return response;
        }

        if (
          lowerMessage.includes("chào") ||
          lowerMessage.includes("xin chào")
        ) {
          return getRandomResponse(aiResponses.greetings);
        } else if (
          lowerMessage.includes("hùng vương") ||
          lowerMessage.includes("vua hùng")
        ) {
          return getRandomResponse(aiResponses.hungVuong);
        } else if (
          lowerMessage.includes("bạch đằng") ||
          lowerMessage.includes("ngô quyền")
        ) {
          return getRandomResponse(aiResponses.bachDang);
        } else if (
          lowerMessage.includes("lý") ||
          lowerMessage.includes("thăng long")
        ) {
          return getRandomResponse(aiResponses.ly);
        } else if (
          lowerMessage.includes("trần") ||
          lowerMessage.includes("đông a")
        ) {
          return getRandomResponse(aiResponses.tran);
        } else if (
          lowerMessage.includes("lê") ||
          lowerMessage.includes("hồng đức")
        ) {
          return getRandomResponse(aiResponses.le);
        } else if (
          lowerMessage.includes("di sản") ||
          lowerMessage.includes("bảo vệ") ||
          lowerMessage.includes("bảo tồn")
        ) {
          return getRandomResponse(aiResponses.heritage);
        } else {
          return getRandomResponse(aiResponses.general);
        }
      }

      function getRandomResponse(responses) {
        const randomIndex = Math.floor(Math.random() * responses.length);
        return responses[randomIndex];
      }

      // --- UI / STATE UPDATES ---

      function showNotification(message, type) {
        notificationText.textContent = message;

        switch (type) {
          case "success":
            notificationIcon.textContent = "✅";
            notification.className = "notification success";
            break;
          case "error":
            notificationIcon.textContent = "❌";
            notification.className = "notification error";
            break;
          case "warning":
            notificationIcon.textContent = "⚠️";
            notification.className = "notification warning";
            break;
          default:
            notificationIcon.textContent = "ℹ️";
            notification.className = "notification";
        }

        notification.classList.add("show");

        setTimeout(() => {
          notification.classList.remove("show");
        }, 3000);
      }

      function updateGameState() {
        const maxEras = Object.keys(eraData).length;

        // Calculate total max knowledge points (13 points * 6 eras = 78)
        const maxKnowledgePoints = maxEras * (5 + 8);

        // Calculate current knowledge percentage
        const currentKnowledgePercent = Math.min(
          100,
          Math.round((gameState.knowledge / maxKnowledgePoints) * 100)
        );

        scoreElement.textContent = gameState.score;
        heritageCountElement.textContent = `${gameState.heritageCount}/${maxEras}`;
        knowledgeElement.textContent = `${currentKnowledgePercent}%`;

        if (impactScreen.classList.contains("active")) {
          updateImpactScreen();
        }
      }

      function updateImpactScreen() {
        const maxEras = Object.keys(eraData).length;
        const knowledgePercent = Math.min(
          100,
          Math.round(
            (gameState.socialImpact.knowledgeRestored / (maxEras * 13)) * 100
          )
        );
        const heritagePercent = Math.min(
          100,
          Math.round(
            (gameState.socialImpact.heritagePreserved / (maxEras * 15)) * 100
          )
        );
        const youthPercent = Math.min(
          100,
          Math.round(
            (gameState.socialImpact.youthEngagement / (maxEras * 5)) * 100
          )
        );
        const awarenessPercent = Math.min(
          100,
          Math.round(
            (gameState.socialImpact.culturalAwareness / (maxEras * 10)) * 100
          )
        );

        updateProgressRing(impactKnowledgeRing, knowledgePercent);
        updateProgressRing(impactHeritageRing, heritagePercent);
        updateProgressRing(impactYouthRing, youthPercent);
        updateProgressRing(impactAwarenessRing, awarenessPercent);

        impactKnowledgeText.textContent = `${knowledgePercent}%`;
        impactHeritageText.textContent = `${heritagePercent}%`;
        impactYouthText.textContent = `${youthPercent}%`;
        impactAwarenessText.textContent = `${awarenessPercent}%`;
      }

      function updateProgressRing(ring, percent) {
        const circumference = 314;
        const offset = circumference - (percent / 100) * circumference;
        ring.style.strokeDashoffset = offset;
      }

      function showSummaryScreen() {
        showScreen("summary-screen");

        const maxEras = Object.keys(eraData).length;
        const maxKnowledgePoints = maxEras * 13;
        const knowledgePercent = Math.min(
          100,
          Math.round((gameState.knowledge / maxKnowledgePoints) * 100)
        );

        finalScore.textContent = gameState.score;
        finalHeritageCount.textContent = `${gameState.heritageCount}/${maxEras}`;
        finalKnowledge.textContent = `${knowledgePercent}%`;

        preservedList.innerHTML = "";
        gameState.preservedHeritages.forEach((eraId) => {
          const era = eraData[eraId];
          const listItem = document.createElement("li");
          const heritageText = era.info
            .match(/<strong>Di sản:<\/strong>(.*?)<p>/g)
            .map((m) =>
              m
                .replace(/<\/?strong>Di sản:<\/strong>/g, "")
                .replace(/<p>/g, "")
                .trim()
            )[0];
          listItem.innerHTML = `<strong>${era.title}:</strong> ${heritageText}...`;
          preservedList.appendChild(listItem);
        });
      }

      function resetGame() {
        gameState.score = 100;
        gameState.heritageCount = 0;
        gameState.knowledge = 0;
        gameState.currentEra = "hungVuong";
        gameState.unlockedEras = ["hungVuong"];
        gameState.preservedHeritages = [];
        gameState.taskProgress = {
          hungVuong: { quizCorrect: 0, puzzleCompleted: 0 },
          bachDang: { quizCorrect: 0, puzzleCompleted: 0 },
          ly: { quizCorrect: 0, puzzleCompleted: 0 },
          tran: { quizCorrect: 0, puzzleCompleted: 0 },
          le: { quizCorrect: 0, puzzleCompleted: 0 },
          modern: { quizCorrect: 0, puzzleCompleted: 0 },
        };
        gameState.socialImpact = {
          knowledgeRestored: 0,
          heritagePreserved: 0,
          youthEngagement: 0,
          culturalAwareness: 0,
        };

        eraCards.forEach((card) => {
          const eraId = card.getAttribute("data-era");
          card.classList.remove("active");
          if (eraId !== "hungVuong") {
            card.classList.add("locked");
          }
        });

        initGame();
        showScreen("menu-screen");
      }

      // Initialize the game
      initGame();
    </script>
  </body>
</html>
