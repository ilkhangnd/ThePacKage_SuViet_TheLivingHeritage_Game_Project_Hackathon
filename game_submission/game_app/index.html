<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S·ª≠ Vi·ªát ‚Äì The Living Heritage</title>
    <style>
      :root {
        --primary: #e2a946;
        --secondary: #931c19;
        --accent: #e8d4a3;
        --danger: #52221f;
        --light: #f5f5f5;
        --dark: #2f191b;
        --text: #333333;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, var(--dark) 0%, #52221f 100%);
        color: var(--text);
        min-height: 100vh;
        overflow-x: hidden;
      }

      .screen {
        display: none;
        animation: fadeIn 0.5s ease;
      }

      .active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        text-align: center;
        padding: 20px 0;
        background: rgba(47, 25, 27, 0.9);
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
      }

      header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
            circle at 20% 30%,
            rgba(232, 212, 163, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 70%,
            rgba(226, 169, 70, 0.1) 0%,
            transparent 50%
          );
        z-index: 0;
      }

      h1 {
        color: var(--accent);
        font-size: 2.8rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        position: relative;
        z-index: 1;
      }

      .subtitle {
        color: var(--light);
        font-size: 1.3rem;
        margin-bottom: 15px;
        position: relative;
        z-index: 1;
      }

      #login-screen {
        text-align: center;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin-top: 20px;
      }

      .login-content {
        position: relative;
        z-index: 1;
        max-width: 500px;
        margin: 0 auto;
      }

      .login-form {
        background: rgba(226, 169, 70, 0.1);
        padding: 25px;
        border-radius: 15px;
        margin: 20px 0;
        text-align: left;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: var(--primary);
      }

      .form-group input {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .form-group input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(226, 169, 70, 0.2);
      }

      #menu-screen,
      #impact-screen,
      #summary-screen {
        text-align: center;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin-top: 20px;
      }

      #menu-screen::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.03"><path d="M30,30 L50,10 L70,30 L70,50 L50,70 L30,50 Z" fill="%232F191B"/></svg>'),
          url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.03"><circle cx="50" cy="50" r="30" fill="%23931C19"/></svg>');
        background-size: 100px 100px, 80px 80px;
        background-position: 10% 20%, 90% 80%;
        z-index: 0;
      }

      .menu-content {
        position: relative;
        z-index: 1;
      }

      .problem-statement {
        background: rgba(147, 28, 25, 0.1);
        border-left: 4px solid var(--secondary);
        padding: 20px;
        margin: 25px 0;
        text-align: left;
        border-radius: 0 12px 12px 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .problem-statement h3 {
        color: var(--secondary);
        margin-bottom: 12px;
        font-size: 1.4rem;
      }

      .stats {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 15px;
        margin: 20px 0;
      }

      .stat-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        flex: 1;
        min-width: 150px;
        text-align: center;
      }

      .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--primary);
        margin-bottom: 5px;
      }

      .btn {
        padding: 16px 32px;
        font-size: 1.2rem;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 10px;
        position: relative;
        overflow: hidden;
        white-space: nowrap;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        transition: left 0.5s;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn-primary {
        background: var(--primary);
        color: var(--dark);
        box-shadow: 0 6px 0 var(--dark);
      }

      .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 9px 0 var(--dark);
      }

      .btn-primary:active {
        transform: translateY(3px);
        box-shadow: 0 3px 0 var(--dark);
      }

      .btn-secondary {
        background: var(--secondary);
        color: white;
        box-shadow: 0 6px 0 #52221f;
      }

      .btn-secondary:hover {
        transform: translateY(-3px);
        box-shadow: 0 9px 0 #52221f;
      }

      .btn-secondary:active {
        transform: translateY(3px);
        box-shadow: 0 3px 0 #52221f;
      }

      .menu-buttons {
        margin-top: 30px;
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 20px;
      }

      #game-screen {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        flex: 1;
        display: flex;
        flex-direction: column;
        margin-top: 20px;
      }

      .game-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--primary);
        flex-wrap: wrap;
        gap: 15px;
      }

      .player-stats {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .stat {
        background: var(--primary);
        color: var(--dark);
        padding: 12px 18px;
        border-radius: 10px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .era-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 20px 0;
        background: rgba(226, 169, 70, 0.1);
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .era-card {
        text-align: center;
        padding: 15px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
        margin: 0 5px;
        position: relative;
        overflow: hidden;
        min-width: 80px;
      }

      .era-card.active {
        background: var(--primary);
        color: var(--dark);
        transform: scale(1.05);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      }

      .era-card.locked {
        opacity: 0.6;
        cursor: not-allowed;
        background: #e0e0e0;
      }

      .era-icon {
        font-size: 2rem;
        margin-bottom: 5px;
      }

      .era-name {
        font-size: 0.8rem;
      }

      .game-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
        flex: 1;
      }

      @media (max-width: 768px) {
        .game-content {
          grid-template-columns: 1fr;
        }

        .era-card {
          margin: 0 3px;
          padding: 10px;
        }
      }

      .content-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }

      .content-card h3 {
        color: var(--primary);
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--accent);
      }

      .task-progress {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: bold;
        color: var(--primary);
      }

      .era-info {
        flex: 1;
        overflow-y: auto;
        max-height: 300px;
      }

      .heritage-item {
        background: rgba(226, 169, 70, 0.1);
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid var(--primary);
      }

      .quiz-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 15px;
      }

      .quiz-option {
        padding: 12px 15px;
        background: #f0f0f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
      }

      .quiz-option:hover {
        background: #e0e0e0;
        transform: translateX(5px);
      }

      .quiz-option.correct {
        background: #4caf50 !important;
        color: white;
      }

      .quiz-option.incorrect {
        background: #f44336 !important;
        color: white;
      }

      .quiz-option.answered {
        pointer-events: none;
        opacity: 0.8;
      }

      .puzzle-area {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
      }

      .puzzle-source,
      .puzzle-target {
        min-height: 150px;
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .puzzle-target {
        background: rgba(226, 169, 70, 0.05);
      }

      .puzzle-piece {
        background: var(--secondary);
        color: white;
        padding: 10px 15px;
        border-radius: 6px;
        cursor: move;
        user-select: none;
        text-align: center;
        transition: all 0.2s ease;
      }

      .puzzle-piece.dragging {
        opacity: 0.7;
        transform: scale(1.05);
      }

      .puzzle-piece.correct {
        background: #4caf50 !important;
      }

      .puzzle-piece.incorrect {
        background: #f44336 !important;
      }

      .ai-assistant {
        grid-column: 1 / -1;
        margin-top: 20px;
      }

      .chat-container {
        height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        background: #f9f9f9;
      }

      .message {
        margin-bottom: 12px;
        padding: 10px 15px;
        border-radius: 10px;
        max-width: 80%;
        animation: messageAppear 0.3s ease;
      }

      @keyframes messageAppear {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .user-message {
        background: #e3f2fd;
        margin-left: auto;
      }

      .ai-message {
        background: #f5f5f5;
      }

      .chat-input {
        display: flex;
        gap: 10px;
      }

      .chat-input input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 25px;
        font-size: 1rem;
      }

      #impact-screen {
        text-align: center;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .impact-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin: 30px 0;
      }

      @media (max-width: 768px) {
        .impact-grid {
          grid-template-columns: 1fr;
        }
      }

      .impact-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: all 0.3s ease;
      }

      .impact-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
      }

      .impact-icon {
        font-size: 3rem;
        margin-bottom: 15px;
      }

      .impact-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--primary);
        margin: 10px 0;
      }

      .progress-ring {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 20px;
      }

      .progress-bg,
      .progress-fill {
        fill: none;
        stroke-width: 8;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
      }

      .progress-bg {
        stroke: #e0e0e0;
      }

      .progress-fill {
        stroke: var(--primary);
        stroke-dasharray: 314;
        stroke-dashoffset: 314;
        transition: stroke-dashoffset 1s ease;
      }

      .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary);
      }

      #summary-screen h2 {
        color: var(--primary);
        font-size: 2rem;
        margin-bottom: 20px;
      }

      #preserved-list {
        list-style-type: "üåü ";
        padding-left: 0;
      }

      #preserved-list li {
        background: var(--light);
        border-radius: 8px;
        padding: 10px 15px;
        margin-bottom: 8px;
        border-left: 5px solid var(--accent);
        text-align: left;
      }

      footer {
        text-align: center;
        margin-top: 30px;
        color: white;
        font-size: 0.9rem;
        opacity: 0.8;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateX(150%);
        transition: transform 0.3s ease;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        border-left: 4px solid #4caf50;
      }

      .notification.error {
        border-left: 4px solid #f44336;
      }

      .notification.warning {
        border-left: 4px solid var(--secondary);
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div id="notification" class="notification">
        <span id="notification-icon">‚ÑπÔ∏è</span>
        <span id="notification-text">Th√¥ng b√°o</span>
      </div>

      <section id="login-screen" class="screen active">
        <header
          style="
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: -40px -40px 30px -40px;
            border-radius: 20px 20px 0 0;
          "
        >
          <img
            src="/game_submission/game_fig/su-viet.png"
            alt="fig"
            style="max-width: 1000px; margin-top: 20px"
          />
          <p
            class="subtitle"
            style="margin-bottom: 10px; font-size: 1.5rem; font-weight: 500"
          >
            Gi·ªØ g√¨n b·∫£n s·∫Øc, vƒÉn h√≥a Vi·ªát
          </p>
        </header>

        <div class="login-content">
          <h2>Ng∆∞·ªùi b·∫£o v·ªá Di s·∫£n</h2>
          <p>
            Vui l√≤ng nh·∫≠p h·ªç v√† t√™n c·ªßa b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu h√†nh tr√¨nh b·∫£o v·ªá di s·∫£n
            vƒÉn h√≥a Vi·ªát Nam.
          </p>

          <div class="login-form">
            <div class="form-group">
              <label for="player-name">H·ªç v√† T√™n:</label>
              <input
                type="text"
                id="player-name"
                placeholder="Nh·∫≠p h·ªç v√† t√™n c·ªßa b·∫°n"
                required
              />
            </div>
            <button
              class="btn btn-primary"
              id="login-btn"
              style="display: block; margin: 0 auto"
            >
              B·∫Øt ƒë·∫ßu h√†nh tr√¨nh
            </button>
          </div>

          <div
            class="history-section"
            style="margin-top: 30px; display: none"
            id="history-section"
          >
            <h3>L·ªãch s·ª≠ tham gia</h3>
            <div
              id="history-list"
              style="
                text-align: left;
                background: rgba(255, 255, 255, 0.8);
                padding: 15px;
                border-radius: 10px;
                max-height: 200px;
                overflow-y: auto;
              "
            ></div>
          </div>
        </div>
      </section>

      <!-- Trang ho·∫°t ƒë·ªông ch√≠nh -->
      <section id="main-screen" class="screen">
        <section id="menu-screen" class="screen active">
          <header>
            <h1>THE LIVING HERITAGE</h1>
            <p class="subtitle">B·∫£o v·ªá VƒÉn h√≥a Vi·ªát - Ch·ªëng l·∫°i s·ª± l√£ng qu√™n</p>
          </header>

          <div class="menu-content">
            <h2>Ch√†o m·ª´ng <span id="player-greeting"></span>!</h2>
            <p>
              Di s·∫£n vƒÉn h√≥a Vi·ªát Nam ƒëang b·ªã ƒëe d·ªça b·ªüi s·ª± l√£ng qu√™n. H√£y c√πng
              ch√∫ng t√¥i h·ªìi sinh nh·ªØng gi√° tr·ªã qu√Ω b√°u!
            </p>

            <div class="problem-statement">
              <h3>V·∫§N ƒê·ªÄ X√É H·ªòI: M·∫•t k·∫øt n·ªëi v·ªõi di s·∫£n vƒÉn h√≥a</h3>
              <p>
                Theo kh·∫£o s√°t, h∆°n 60% gi·ªõi tr·∫ª Vi·ªát Nam kh√¥ng bi·∫øt v·ªÅ c√°c di
                s·∫£n vƒÉn h√≥a ƒë·ªãa ph∆∞∆°ng. Ki·∫øn th·ª©c l·ªãch s·ª≠ ƒëang d·∫ßn b·ªã l√£ng qu√™n,
                ƒëe d·ªça ƒë·∫øn b·∫£n s·∫Øc vƒÉn h√≥a d√¢n t·ªôc.
              </p>
            </div>

            <div class="stats">
              <div class="stat-card">
                <div class="stat-value">67%</div>
                <div class="stat-label">Gi·ªõi tr·∫ª thi·∫øu ki·∫øn th·ª©c l·ªãch s·ª≠</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">42%</div>
                <div class="stat-label">Di s·∫£n ƒëang b·ªã ƒëe d·ªça</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">58%</div>
                <div class="stat-label">
                  Kh√¥ng quan t√¢m ƒë·∫øn vƒÉn h√≥a truy·ªÅn th·ªëng
                </div>
              </div>
            </div>

            <div class="menu-buttons">
              <button class="btn btn-primary" id="start-btn">
                B·∫Øt ƒê·∫ßu H√†nh Tr√¨nh
              </button>
              <button class="btn btn-secondary" id="impact-btn">
                Xem T√°c ƒê·ªông
              </button>
              <button class="btn btn-secondary" id="logout-btn">
                ƒêƒÉng Xu·∫•t
              </button>
            </div>
          </div>
        </section>

        <section id="game-screen" class="screen">
          <div class="game-header">
            <h2 id="era-title">Th·ªùi K·ª≥ Vua H√πng</h2>
            <div class="player-stats">
              <div class="stat">
                <span>ü™ô</span>
                <span id="score">100</span>
              </div>
              <div class="stat">
                <span>üèõÔ∏è</span>
                <span id="heritage-count">0/6</span>
              </div>
              <div class="stat">
                <span>üìö</span>
                <span id="knowledge">0%</span>
              </div>
              <button class="btn btn-secondary" id="back-btn">Quay L·∫°i</button>
            </div>
          </div>

          <div class="era-navigation">
            <div class="era-card active" data-era="hungVuong">
              <div class="era-icon">üëë</div>
              <div class="era-name">Vua H√πng</div>
            </div>
            <div class="era-card locked" data-era="bachDang">
              <div class="era-icon">‚öîÔ∏è</div>
              <div class="era-name">Ng√¥ Quy·ªÅn</div>
            </div>
            <div class="era-card locked" data-era="ly">
              <div class="era-icon">üèØ</div>
              <div class="era-name">Nh√† L√Ω</div>
            </div>
            <div class="era-card locked" data-era="tran">
              <div class="era-icon">üõ°Ô∏è</div>
              <div class="era-name">Nh√† Tr·∫ßn</div>
            </div>
            <div class="era-card locked" data-era="le">
              <div class="era-icon">‚öñÔ∏è</div>
              <div class="era-name">Nh√† L√™</div>
            </div>
            <div class="era-card locked" data-era="modern">
              <div class="era-icon">üåè</div>
              <div class="era-name">Hi·ªán ƒê·∫°i</div>
            </div>
          </div>

          <div class="game-content">
            <div class="content-card">
              <h3>Th√¥ng Tin Th·ªùi K·ª≥</h3>
              <div class="era-info" id="era-info"></div>
              <button
                class="btn btn-primary"
                id="preserve-btn"
                style="margin-top: 15px"
              >
                B·∫£o V·ªá Di S·∫£n
              </button>
            </div>

            <div class="content-card">
              <h3>Ki·ªÉm Tra Ki·∫øn Th·ª©c (Quiz)</h3>
              <div class="task-progress" id="quiz-progress">
                Ti·∫øn ƒë·ªô: 0/3 c√¢u ƒë√∫ng (Y√™u c·∫ßu: 70%)
              </div>
              <div class="quiz-question" id="quiz-question"></div>
              <div class="quiz-options" id="quiz-options"></div>
              <div
                id="quiz-feedback"
                style="margin-top: 15px; font-weight: bold"
              ></div>
              <button
                class="btn btn-secondary"
                id="next-quiz-btn"
                style="margin-top: 10px; display: none"
              >
                C√¢u Ti·∫øp Theo
              </button>
            </div>

            <div class="content-card">
              <h3>Gh√©p M·∫£nh L·ªãch S·ª≠ (Puzzle)</h3>
              <div class="task-progress" id="puzzle-progress">
                Ti·∫øn ƒë·ªô: 0/2 nhi·ªám v·ª• (Y√™u c·∫ßu: 70%)
              </div>
              <div id="puzzle-instruction"></div>
              <div class="puzzle-area">
                <div class="puzzle-source" id="puzzle-source"></div>
                <div class="puzzle-target" id="puzzle-target">
                  <div class="placeholder">K√©o c√°c s·ª± ki·ªán v√†o ƒë√¢y</div>
                </div>
              </div>
              <button
                class="btn btn-primary"
                id="check-puzzle"
                style="margin-top: 15px"
              >
                Ki·ªÉm Tra
              </button>
              <div
                id="puzzle-feedback"
                style="margin-top: 15px; font-weight: bold"
              ></div>
            </div>

            <div class="content-card ai-assistant">
              <h3>Tr·ª£ L√Ω Di S·∫£n AI</h3>
              <div class="chat-container" id="chat-container">
                <div class="message ai-message">
                  Xin ch√†o! T√¥i l√† tr·ª£ l√Ω di s·∫£n AI. T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n
                  trong h√†nh tr√¨nh b·∫£o v·ªá vƒÉn h√≥a Vi·ªát Nam?
                </div>
              </div>
              <div class="chat-input">
                <input
                  type="text"
                  id="user-input"
                  placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n v·ªÅ l·ªãch s·ª≠..."
                />
                <button class="btn btn-primary" id="send-btn">G·ª≠i</button>
              </div>
            </div>
          </div>
        </section>

        <section id="impact-screen" class="screen">
          <header>
            <h1>T√ÅC ƒê·ªòNG X√É H·ªòI</h1>
            <p class="subtitle">
              Nh·ªØng ƒë√≥ng g√≥p c·ªßa b·∫°n t·∫°o ra s·ª± thay ƒë·ªïi t√≠ch c·ª±c
            </p>
          </header>

          <div class="impact-grid">
            <div class="impact-card">
              <div class="progress-ring">
                <svg width="120" height="120" viewBox="0 0 120 120">
                  <circle class="progress-bg" cx="60" cy="60" r="50"></circle>
                  <circle
                    class="progress-fill"
                    cx="60"
                    cy="60"
                    r="50"
                    id="impact-knowledge-ring"
                  ></circle>
                </svg>
                <div class="progress-text" id="impact-knowledge-text">0%</div>
              </div>
              <h3>Ki·∫øn th·ª©c ƒë∆∞·ª£c kh√¥i ph·ª•c</h3>
              <p>L∆∞·ª£ng ki·∫øn th·ª©c l·ªãch s·ª≠ ƒë∆∞·ª£c lan t·ªèa trong c·ªông ƒë·ªìng</p>
            </div>

            <div class="impact-card">
              <div class="progress-ring">
                <svg width="120" height="120" viewBox="0 0 120 120">
                  <circle class="progress-bg" cx="60" cy="60" r="50"></circle>
                  <circle
                    class="progress-fill"
                    cx="60"
                    cy="60"
                    r="50"
                    id="impact-heritage-ring"
                  ></circle>
                </svg>
                <div class="progress-text" id="impact-heritage-text">0%</div>
              </div>
              <h3>Di s·∫£n ƒë∆∞·ª£c b·∫£o v·ªá</h3>
              <p>S·ªë di s·∫£n vƒÉn h√≥a ƒë∆∞·ª£c b·∫£o t·ªìn cho th·∫ø h·ªá t∆∞∆°ng lai</p>
            </div>

            <div class="impact-card">
              <div class="progress-ring">
                <svg width="120" height="120" viewBox="0 0 120 120">
                  <circle class="progress-bg" cx="60" cy="60" r="50"></circle>
                  <circle
                    class="progress-fill"
                    cx="60"
                    cy="60"
                    r="50"
                    id="impact-youth-ring"
                  ></circle>
                </svg>
                <div class="progress-text" id="impact-youth-text">0%</div>
              </div>
              <h3>Gi·ªõi tr·∫ª quan t√¢m</h3>
              <p>T·ª∑ l·ªá gi·ªõi tr·∫ª quan t√¢m ƒë·∫øn l·ªãch s·ª≠ v√† di s·∫£n vƒÉn h√≥a</p>
            </div>

            <div class="impact-card">
              <div class="progress-ring">
                <svg width="120" height="120" viewBox="0 0 120 120">
                  <circle class="progress-bg" cx="60" cy="60" r="50"></circle>
                  <circle
                    class="progress-fill"
                    cx="60"
                    cy="60"
                    r="50"
                    id="impact-awareness-ring"
                  ></circle>
                </svg>
                <div class="progress-text" id="impact-awareness-text">0%</div>
              </div>
              <h3>Nh·∫≠n th·ª©c c·ªông ƒë·ªìng</h3>
              <p>M·ª©c ƒë·ªô nh·∫≠n th·ª©c v·ªÅ gi√° tr·ªã di s·∫£n trong c·ªông ƒë·ªìng</p>
            </div>
          </div>

          <div style="margin-top: 30px">
            <button class="btn btn-primary" id="back-from-impact">
              Quay L·∫°i
            </button>
          </div>
        </section>

        <section id="summary-screen" class="screen">
          <header>
            <h1>HO√ÄN TH√ÄNH H√ÄNH TR√åNH!</h1>
            <p class="subtitle">B·∫°n ƒë√£ tr·ªü th√†nh Ng∆∞·ªùi B·∫£o V·ªá Di S·∫£n vƒ© ƒë·∫°i!</p>
          </header>

          <div class="menu-content">
            <h2>K·∫æT QU·∫¢ T·ªîNG K·∫æT</h2>
            <p>
              Xin ch√∫c m·ª´ng <span id="player-summary-name"></span>! B·∫°n ƒë√£ ho√†n
              th√†nh h√†nh tr√¨nh qua c√°c th·ªùi k·ª≥ l·ªãch s·ª≠ Vi·ªát Nam v√† b·∫£o v·ªá th√†nh
              c√¥ng c√°c di s·∫£n qu√Ω gi√°.
            </p>

            <div class="stats" id="summary-stats-general">
              <div class="stat-card">
                <div class="stat-value" id="final-score">0</div>
                <div class="stat-label">T·ªïng ƒêi·ªÉm Di S·∫£n</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="final-heritage-count">0/6</div>
                <div class="stat-label">Di S·∫£n ƒê√£ B·∫£o V·ªá</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="final-knowledge">0%</div>
                <div class="stat-label">Ki·∫øn Th·ª©c T·ªïng Th·ªÉ</div>
              </div>
            </div>

            <h3>Danh S√°ch Di S·∫£n ƒê∆∞·ª£c B·∫£o V·ªá:</h3>
            <ul
              id="preserved-list"
              style="
                text-align: left;
                list-style-type: 'üåü ';
                margin: 20px auto;
                max-width: 600px;
                padding-left: 20px;
              "
            ></ul>

            <div style="margin-top: 30px">
              <button class="btn btn-primary" id="restart-btn">Ch∆°i L·∫°i</button>
              <button class="btn btn-secondary" id="back-to-menu-summary">
                V·ªÅ Menu
              </button>
            </div>
          </div>
        </section>
      </section>

      <footer>
        <p>¬© 2025 S·ª¨ VI·ªÜT - THE LIVING HERITAGE</p>
      </footer>
    </div>

    <script>
      // Game State Management
      const gameState = {
        playerName: "",
        score: 100,
        heritageCount: 0,
        knowledge: 0,
        currentEra: "hungVuong",
        unlockedEras: ["hungVuong"],
        preservedHeritages: [],
        taskProgress: {
          hungVuong: { quizCorrect: 0, puzzleCompleted: 0 },
          bachDang: { quizCorrect: 0, puzzleCompleted: 0 },
          ly: { quizCorrect: 0, puzzleCompleted: 0 },
          tran: { quizCorrect: 0, puzzleCompleted: 0 },
          le: { quizCorrect: 0, puzzleCompleted: 0 },
          modern: { quizCorrect: 0, puzzleCompleted: 0 },
        },
        quizCurrentIndex: 0,
        puzzleCurrentIndex: 0,
        socialImpact: {
          knowledgeRestored: 0,
          heritagePreserved: 0,
          youthEngagement: 0,
          culturalAwareness: 0,
        },
      };

      // CONSTANTS
      const QUIZ_PASS_RATE = 0.7; // 70%
      const PUZZLE_PASS_RATE = 0.7; // 70%

      // Era Data with Enhanced Content and Multi-Quiz/Puzzle
      const eraData = {
        hungVuong: {
          title: "Th·ªùi K·ª≥ Vua H√πng",
          info: `
                    <p><strong>Th·ªùi gian:</strong> Kho·∫£ng th·∫ø k·ª∑ VII TCN - th·∫ø k·ª∑ III TCN. ƒê√¢y l√† th·ªùi k·ª≥ h√¨nh th√†nh nh√† n∆∞·ªõc VƒÉn Lang, m·ªü ƒë·∫ßu cho l·ªãch s·ª≠ d√¢n t·ªôc Vi·ªát Nam.</p>
                    <p><strong>Nh√† n∆∞·ªõc:</strong> VƒÉn Lang - nh√† n∆∞·ªõc ƒë·∫ßu ti√™n c·ªßa ng∆∞·ªùi Vi·ªát v·ªõi 18 ƒë·ªùi Vua H√πng tr·ªã v√¨. T·ªï ch·ª©c x√£ h·ªôi ƒë∆°n gi·∫£n, d·ª±a tr√™n c√°c c√¥ng x√£ n√¥ng th√¥n (chi·ªÅng, ch·∫°).</p>
                    <div class="heritage-item">
                        <strong>Di s·∫£n:</strong> Tr·ªëng ƒë·ªìng ƒê√¥ng S∆°n
                        <p>Bi·ªÉu t∆∞·ª£ng c·ªßa n·ªÅn vƒÉn minh l√∫a n∆∞·ªõc, v·ªõi hoa vƒÉn tinh x·∫£o th·ªÉ hi·ªán ƒë·ªùi s·ªëng vƒÉn h√≥a, t√≠n ng∆∞·ª°ng (nh·∫£y m√∫a, gi√£ g·∫°o) v√† k·ªπ thu·∫≠t luy·ªán kim ƒë·ªìng thau c·ªßa ng∆∞·ªùi Vi·ªát c·ªï.</p>
                    </div>
                    <div class="heritage-item">
                        <strong>Di s·∫£n:</strong> Truy·ªÅn thuy·∫øt Con R·ªìng Ch√°u Ti√™n
                        <p>Huy·ªÅn tho·∫°i v·ªÅ ngu·ªìn g·ªëc d√¢n t·ªôc (L·∫°c Long Qu√¢n - √Çu C∆°), th·ªÉ hi·ªán tinh th·∫ßn ƒëo√†n k·∫øt v√† ni·ªÅm t·ª± h√†o v·ªÅ n√≤i gi·ªëng Ti√™n R·ªìng.</p>
                    </div>
                `,
          quizs: [
            // 3 Quiz questions
            {
              question:
                "Nh√† n∆∞·ªõc ƒë·∫ßu ti√™n trong l·ªãch s·ª≠ Vi·ªát Nam c√≥ t√™n l√† g√¨?",
              options: [
                { text: "VƒÉn Lang", correct: true },
                { text: "√Çu L·∫°c", correct: false },
                { text: "ƒê·∫°i Vi·ªát", correct: false },
              ],
            },
            {
              question: "VƒÉn minh ƒê√¥ng S∆°n n·ªïi ti·∫øng v·ªõi lo·∫°i h√¨nh di s·∫£n n√†o?",
              options: [
                { text: "Ch√πa M·ªôt C·ªôt", correct: false },
                { text: "Tr·ªëng ƒë·ªìng", correct: true },
                { text: "Ki·∫øn tr√∫c ƒë√°", correct: false },
              ],
            },
            {
              question:
                "Truy·ªÅn thuy·∫øt n√†o n√≥i v·ªÅ ngu·ªìn g·ªëc c·ªßa d√¢n t·ªôc Vi·ªát Nam?",
              options: [
                { text: "S∆°n Tinh Th·ªßy Tinh", correct: false },
                { text: "B√°nh ch∆∞ng, b√°nh gi·∫ßy", correct: false },
                { text: "Con R·ªìng Ch√°u Ti√™n", correct: true },
              ],
            },
          ],
          puzzles: [
            // 2 Puzzle missions
            {
              instruction: "S·∫Øp x·∫øp th·ª© t·ª± c√°c m·ªëc ch√≠nh:",
              pieces: [
                { text: "Th√†nh l·∫≠p n∆∞·ªõc VƒÉn Lang", order: 1 },
                { text: "18 ƒë·ªùi Vua H√πng", order: 2 },
                { text: "Ph√°t tri·ªÉn tr·ªëng ƒë·ªìng ƒê√¥ng S∆°n", order: 3 },
              ],
            },
            {
              instruction: "S·∫Øp x·∫øp theo √Ω nghƒ©a t∆∞·ª£ng tr∆∞ng:",
              pieces: [
                { text: "B√°nh ch∆∞ng (ƒê·∫•t)", order: 1 },
                { text: "B√°nh gi·∫ßy (Tr·ªùi)", order: 2 },
                { text: "Truy·ªÅn ng√¥i cho Lang Li√™u", order: 3 },
              ],
            },
          ],
        },
        bachDang: {
          title: "Ng√¥ Quy·ªÅn v√† Chi·∫øn th·∫Øng B·∫°ch ƒê·∫±ng",
          info: `
                    <p><strong>Th·ªùi gian:</strong> NƒÉm 938. ƒê√¢y l√† tr·∫≠n chi·∫øn mang t√≠nh b∆∞·ªõc ngo·∫∑t, ch·∫•m d·ª©t h∆°n 1000 nƒÉm B·∫Øc thu·ªôc.</p>
                    <p><strong>S·ª± ki·ªán:</strong> Chi·∫øn th·∫Øng B·∫°ch ƒê·∫±ng ch·ªëng qu√¢n Nam H√°n d∆∞·ªõi s·ª± l√£nh ƒë·∫°o c·ªßa Ng√¥ Quy·ªÅn, ng∆∞·ªùi sau ƒë√≥ x∆∞ng v∆∞∆°ng, m·ªü ra th·ªùi k·ª≥ ƒë·ªôc l·∫≠p t·ª± ch·ªß l√¢u d√†i.</p>
                    <div class="heritage-item">
                        <strong>Di s·∫£n:</strong> Chi·∫øn thu·∫≠t c·ªçc B·∫°ch ƒê·∫±ng
                        <p>Tr·∫≠n ƒë·ªãa c·ªçc ng·∫ßm ƒë∆∞·ª£c ƒë√≥ng ·ªü c·ª≠a s√¥ng B·∫°ch ƒê·∫±ng, l·ª£i d·ª•ng th·ªßy tri·ªÅu l√™n xu·ªëng ƒë·ªÉ ƒë√°nh b·∫°i th·ªßy qu√¢n Nam H√°n. ƒê√¢y l√† m·ªôt s√°ng t·∫°o qu√¢n s·ª± vƒ© ƒë·∫°i.</p>
                    </div>
                    <div class="heritage-item">
                        <strong>Di s·∫£n:</strong> Tinh th·∫ßn ƒë·ªôc l·∫≠p d√¢n t·ªôc
                        <p>Chi·∫øn th·∫Øng nƒÉm 938 kh·∫≥ng ƒë·ªãnh √Ω ch√≠ ƒë·ªôc l·∫≠p t·ª± ch·ªß, m·ªü ra k·ª∑ nguy√™n phong ki·∫øn trung ∆∞∆°ng t·∫≠p quy·ªÅn c·ªßa Vi·ªát Nam.</p>
                    </div>
                `,
          quizs: [
            {
              question:
                "Tr·∫≠n B·∫°ch ƒê·∫±ng do Ng√¥ Quy·ªÅn l√£nh ƒë·∫°o di·ªÖn ra v√†o nƒÉm n√†o?",
              options: [
                { text: "NƒÉm 938", correct: true },
                { text: "NƒÉm 939", correct: false },
                { text: "NƒÉm 940", correct: false },
              ],
            },
            {
              question:
                "M·ª•c ƒë√≠ch ch√≠nh c·ªßa vi·ªác ƒë√≥ng c·ªçc tr√™n s√¥ng B·∫°ch ƒê·∫±ng l√† g√¨?",
              options: [
                { text: "Ch·∫∑n ƒë∆∞·ªùng ti·∫øn qu√¢n", correct: false },
                {
                  text: "L·ª£i d·ª•ng th·ªßy tri·ªÅu ƒë·ªÉ ƒë√¢m thuy·ªÅn gi·∫∑c",
                  correct: true,
                },
                { text: "ƒê·ªÉ thuy·ªÅn ta neo ƒë·∫≠u", correct: false },
              ],
            },
            {
              question:
                "Chi·∫øn th·∫Øng B·∫°ch ƒê·∫±ng c√≥ √Ω nghƒ©a g√¨ ƒë·ªëi v·ªõi l·ªãch s·ª≠ Vi·ªát Nam?",
              options: [
                { text: "Ch·∫•m d·ª©t ho√†n to√†n √°ch B·∫Øc thu·ªôc", correct: true },
                { text: "M·ªü ra nh√† n∆∞·ªõc phong ki·∫øn ƒë·∫ßu ti√™n", correct: false },
                { text: "B·∫£o v·ªá VƒÉn Lang", correct: false },
              ],
            },
          ],
          puzzles: [
            {
              instruction: "S·∫Øp x·∫øp c√°c b∆∞·ªõc chu·∫©n b·ªã chi·∫øn ƒë·∫•u:",
              pieces: [
                { text: "Ng√¥ Quy·ªÅn t·∫≠p h·ª£p l·ª±c l∆∞·ª£ng", order: 1 },
                { text: "ƒê√≥ng c·ªçc tr√™n s√¥ng B·∫°ch ƒê·∫±ng", order: 2 },
                { text: "D·ª• ƒë·ªãch v√†o tr·∫≠n ƒë·ªãa", order: 3 },
              ],
            },
            {
              instruction: "S·∫Øp x·∫øp theo th·ªùi gian:",
              pieces: [
                { text: "Ng√¥ Quy·ªÅn x∆∞ng V∆∞∆°ng", order: 1 },
                { text: "ƒê√°nh b·∫°i qu√¢n Nam H√°n", order: 2 },
                { text: "Thi·∫øt l·∫≠p tri·ªÅu ƒë√¨nh", order: 3 },
              ],
            },
          ],
        },
        ly: {
          title: "Nh√† L√Ω v√† Kinh ƒë√¥ ThƒÉng Long",
          info: `
                    <p><strong>Th·ªùi gian:</strong> 1009 - 1225. ƒê√¢y l√† tri·ªÅu ƒë·∫°i m·ªü ƒë·∫ßu cho th·ªùi k·ª≥ ƒë·ªôc l·∫≠p, t·ª± ch·ªß v√† x√¢y d·ª±ng vƒÉn h√≥a r·ª±c r·ª° c·ªßa Vi·ªát Nam.</p>
                    <p><strong>Kinh ƒë√¥:</strong> ThƒÉng Long (H√† N·ªôi ng√†y nay). Vua L√Ω Th√°i T·ªï (L√Ω C√¥ng U·∫©n) d·ªùi ƒë√¥ t·ª´ Hoa L∆∞ v·ªÅ ƒê·∫°i La, ƒë·ªïi t√™n l√† ThƒÉng Long (R·ªìng bay l√™n) v√†o nƒÉm 1010.</p>
                    <div class="heritage-item">
                        <strong>Di s·∫£n:</strong> Ch√πa M·ªôt C·ªôt
                        <p>ƒê∆∞·ª£c x√¢y d·ª±ng nƒÉm 1049, l√† bi·ªÉu t∆∞·ª£ng c·ªßa Ph·∫≠t gi√°o Vi·ªát Nam d∆∞·ªõi th·ªùi L√Ω. Ki·∫øn tr√∫c ƒë·ªôc ƒë√°o h√¨nh b√¥ng sen n·ªü tr√™n c·ªôt ƒë√°, th·ªÉ hi·ªán s·ª± s√°ng t·∫°o trong ki·∫øn tr√∫c t√¥n gi√°o.</p>
                    </div>
                    <div class="heritage-item">
                        <strong>Di s·∫£n:</strong> VƒÉn Mi·∫øu - Qu·ªëc T·ª≠ Gi√°m
                        <p>ƒê∆∞·ª£c x√¢y d·ª±ng nƒÉm 1070 (VƒÉn Mi·∫øu) v√† 1076 (Qu·ªëc T·ª≠ Gi√°m - tr∆∞·ªùng ƒë·∫°i h·ªçc ƒë·∫ßu ti√™n). ƒê√¢y l√† bi·ªÉu t∆∞·ª£ng c·ªßa truy·ªÅn th·ªëng hi·∫øu h·ªçc v√† tr·ªçng nh√¢n t√†i c·ªßa d√¢n t·ªôc.</p>
                    </div>
                `,
          quizs: [
            {
              question:
                "Ai l√† ng∆∞·ªùi s√°ng l·∫≠p ra nh√† L√Ω v√† d·ªùi ƒë√¥ v·ªÅ ThƒÉng Long?",
              options: [
                { text: "L√Ω C√¥ng U·∫©n", correct: true },
                { text: "L√Ω Th√°nh T√¥ng", correct: false },
                { text: "L√Ω Nh√¢n T√¥ng", correct: false },
              ],
            },
            {
              question: "VƒÉn Mi·∫øu ƒë∆∞·ª£c x√¢y d·ª±ng v√†o nƒÉm n√†o?",
              options: [
                { text: "NƒÉm 1010", correct: false },
                { text: "NƒÉm 1070", correct: true },
                { text: "NƒÉm 1076", correct: false },
              ],
            },
            {
              question: "√ù nghƒ©a c·ªßa vi·ªác ƒë·∫∑t t√™n kinh ƒë√¥ l√† ThƒÉng Long?",
              options: [
                { text: "ƒê·ªãa ƒëi·ªÉm qu√¢n s·ª± chi·∫øn l∆∞·ª£c", correct: false },
                {
                  text: "T∆∞·ª£ng tr∆∞ng cho v·∫≠n n∆∞·ªõc 'R·ªìng bay l√™n'",
                  correct: true,
                },
                { text: "N∆°i c√≥ nhi·ªÅu s√¥ng h·ªì", correct: false },
              ],
            },
          ],
          puzzles: [
            {
              instruction: "S·∫Øp x·∫øp c√°c m·ªëc th·ªùi gian:",
              pieces: [
                { text: "L√Ω C√¥ng U·∫©n l√™n ng√¥i", order: 1 },
                { text: "D·ªùi ƒë√¥ v·ªÅ ThƒÉng Long (1010)", order: 2 },
                { text: "Th√†nh l·∫≠p Qu·ªëc T·ª≠ Gi√°m (1076)", order: 3 },
              ],
            },
            {
              instruction: "S·∫Øp x·∫øp theo m·ªëi li√™n h·ªá:",
              pieces: [
                { text: "Ph·∫≠t gi√°o ph√°t tri·ªÉn", order: 1 },
                { text: "X√¢y ch√πa M·ªôt C·ªôt", order: 2 },
                { text: "Tr·ªçng d·ª•ng nh√¢n t√†i", order: 3 },
              ],
            },
          ],
        },
        tran: {
          title: "Nh√† Tr·∫ßn v√† H√†o kh√≠ ƒê√¥ng A",
          info: `
                    <p><strong>Th·ªùi gian:</strong> 1225 - 1400. N·ªïi ti·∫øng v·ªõi chi·∫øn c√¥ng ba l·∫ßn ƒë√°nh b·∫°i qu√¢n Nguy√™n M√¥ng h√πng m·∫°nh, gi·ªØ v·ªØng n·ªÅn ƒë·ªôc l·∫≠p d√¢n t·ªôc.</p>
                    <p><strong>S·ª± ki·ªán:</strong> H·ªôi ngh·ªã Di√™n H·ªìng (1284) v·ªõi s·ª± tham gia c·ªßa c√°c b√¥ l√£o, th·ªÉ hi·ªán √Ω ch√≠ "Vua t√¥i ƒë·ªìng l√≤ng, anh em h√≤a thu·∫≠n" ch·ªëng gi·∫∑c. H∆∞ng ƒê·∫°o V∆∞∆°ng Tr·∫ßn Qu·ªëc Tu·∫•n l√† v·ªã t∆∞·ªõng t√†i ba nh·∫•t.</p>
                    <div class="heritage-item">
                        <strong>Di s·∫£n:</strong> Tinh th·∫ßn ƒê√¥ng A (H√†o kh√≠ ƒê√¥ng A)
                        <p>Ch·ªØ H√°n c·ªßa h·ªç Tr·∫ßn (Èô≥) ƒë∆∞·ª£c t√°ch th√†nh hai ch·ªØ ƒê√¥ng (Êù±) v√† A (Èòø). "H√†o kh√≠ ƒê√¥ng A" bi·ªÉu tr∆∞ng cho √Ω ch√≠ ƒëo√†n k·∫øt, l√≤ng y√™u n∆∞·ªõc v√† s·ª©c m·∫°nh c·ªßa tri·ªÅu ƒë·∫°i nh√† Tr·∫ßn trong l·ªãch s·ª≠ ch·ªëng Nguy√™n M√¥ng.</p>
                    </div>
                    <div class="heritage-item">
                        <strong>Di s·∫£n:</strong> Thi·ªÅn ph√°i Tr√∫c L√¢m Y√™n T·ª≠
                        <p>Do vua Tr·∫ßn Nh√¢n T√¥ng s√°ng l·∫≠p, l√† d√≤ng Thi·ªÅn mang ƒë·∫≠m b·∫£n s·∫Øc Vi·ªát, ƒë√°nh d·∫•u s·ª± ph√°t tri·ªÉn ƒë·ªôc l·∫≠p, t·ª± ch·ªß c·ªßa Ph·∫≠t gi√°o Vi·ªát Nam, kh√¥ng c√≤n ch·ªãu ·∫£nh h∆∞·ªüng c·ªßa c√°c n∆∞·ªõc l√¢n c·∫≠n.</p>
                    </div>
                `,
          quizs: [
            {
              question:
                "Danh t∆∞·ªõng n√†o g·∫Øn li·ªÅn v·ªõi c√¢u n√≥i n·ªïi ti·∫øng 'S√°t Th√°t' v√† l√£nh ƒë·∫°o qu√¢n ƒë·ªôi ƒë√°nh b·∫°i Nguy√™n M√¥ng?",
              options: [
                { text: "Tr·∫ßn H∆∞ng ƒê·∫°o", correct: true },
                { text: "Tr·∫ßn Th·ªß ƒê·ªô", correct: false },
                { text: "Tr·∫ßn Quang Kh·∫£i", correct: false },
              ],
            },
            {
              question: "H·ªôi ngh·ªã Di√™n H·ªìng c√≥ s·ª± tham gia c·ªßa ai?",
              options: [
                { text: "C√°c ƒë·∫°i th·∫ßn", correct: false },
                { text: "C√°c b√¥ l√£o", correct: true },
                { text: "T·∫•t c·∫£ quan l·∫°i", correct: false },
              ],
            },
            {
              question:
                "Thi·ªÅn ph√°i Tr√∫c L√¢m Y√™n T·ª≠ ƒë∆∞·ª£c th√†nh l·∫≠p b·ªüi v·ªã vua n√†o?",
              options: [
                { text: "Tr·∫ßn Th√°i T√¥ng", correct: false },
                { text: "Tr·∫ßn Nh√¢n T√¥ng", correct: true },
                { text: "Tr·∫ßn Anh T√¥ng", correct: false },
              ],
            },
          ],
          puzzles: [
            {
              instruction: "S·∫Øp x·∫øp th·ª© t·ª± c√°c m·ªëc tri·ªÅu ƒë·∫°i:",
              pieces: [
                { text: "Tr·∫ßn C·∫£nh l√™n ng√¥i", order: 1 },
                { text: "Chi·∫øn th·∫Øng Nguy√™n M√¥ng l·∫ßn 1 (1258)", order: 2 },
                { text: "H·ªôi ngh·ªã Di√™n H·ªìng (1284)", order: 3 },
              ],
            },
            {
              instruction: "S·∫Øp x·∫øp theo m·ªëi li√™n h·ªá:",
              pieces: [
                { text: "Ph·∫≠t gi√°o ph√°t tri·ªÉn", order: 1 },
                { text: "Ra ƒë·ªùi Thi·ªÅn ph√°i Tr√∫c L√¢m", order: 2 },
                { text: "Tr·∫ßn Nh√¢n T√¥ng ƒëi tu", order: 3 },
              ],
            },
          ],
        },
        le: {
          title: "Nh√† L√™ S∆° v√† C·∫£i c√°ch H·ªìng ƒê·ª©c",
          info: `
                    <p><strong>Th·ªùi gian:</strong> 1428 - 1789 (Th·ªùi k·ª≥ L√™ S∆°: 1428-1527). Th·ªùi k·ª≥ ƒë·ªânh cao c·ªßa ch·∫ø ƒë·ªô phong ki·∫øn Vi·ªát Nam, b·∫Øt ƒë·∫ßu t·ª´ L√™ Th√°i T·ªï (L√™ L·ª£i).</p>
                    <p><strong>Vua ti√™u bi·ªÉu:</strong> L√™ Th√°nh T√¥ng (tr·ªã v√¨ 1460-1497) v·ªõi c√°c cu·ªôc c·∫£i c√°ch to√†n di·ªán v·ªÅ h√†nh ch√≠nh, kinh t·∫ø, gi√°o d·ª•c v√† ph√°p lu·∫≠t, ƒë∆∞a ƒë·∫•t n∆∞·ªõc ph√°t tri·ªÉn c·ª±c th·ªãnh.</p>
                    <div class="heritage-item">
                        <strong>Di s·∫£n:</strong> B·ªô lu·∫≠t H·ªìng ƒê·ª©c (Qu·ªëc tri·ªÅu h√¨nh lu·∫≠t)
                        <p>B·ªô lu·∫≠t ho√†n ch·ªânh v√† ti·∫øn b·ªô nh·∫•t trong l·ªãch s·ª≠ phong ki·∫øn Vi·ªát Nam. ƒê√°ng ch√∫ √Ω l√† b·∫£o v·ªá quy·ªÅn l·ª£i ph·ª• n·ªØ v√† n√¥ng d√¢n, th·ªÉ hi·ªán t∆∞ t∆∞·ªüng ph√°p tr·ªã c·ªßa nh√† n∆∞·ªõc.</p>
                    </div>
                    <div class="heritage-item">
                        <strong>Di s·∫£n:</strong> Bia Ti·∫øn sƒ© t·∫°i VƒÉn Mi·∫øu
                        <p>Ti·∫øp t·ª•c truy·ªÅn th·ªëng tr·ªçng h·ªçc, Nh√† L√™ S∆° t·ªï ch·ª©c nhi·ªÅu khoa thi. Vi·ªác d·ª±ng Bia Ti·∫øn sƒ© (t·ª´ nƒÉm 1484) l√† ƒë·ªÉ ghi danh c√°c nh√¢n t√†i, khuy·∫øn kh√≠ch h·ªçc t·∫≠p.</p>
                    </div>
                `,
          quizs: [
            {
              question:
                "Ai l√† ng∆∞·ªùi ƒë√£ gi·∫£i ph√≥ng ƒë·∫•t n∆∞·ªõc kh·ªèi √°ch ƒë√¥ h·ªô c·ªßa nh√† Minh, l·∫≠p ra Nh√† L√™ S∆°?",
              options: [
                { text: "L√™ Th√°nh T√¥ng", correct: false },
                { text: "L√™ L·ª£i (L√™ Th√°i T·ªï)", correct: true },
                { text: "Nguy·ªÖn Tr√£i", correct: false },
              ],
            },
            {
              question:
                "B·ªô lu·∫≠t ti√™u bi·ªÉu nh·∫•t d∆∞·ªõi th·ªùi Nh√† L√™ S∆°, b·∫£o v·ªá quy·ªÅn l·ª£i ph·ª• n·ªØ l√† g√¨?",
              options: [
                { text: "B·ªô lu·∫≠t H√¨nh s·ª±", correct: false },
                { text: "B·ªô lu·∫≠t H·ªìng ƒê·ª©c", correct: true },
                { text: "Ho√†ng tri·ªÅu lu·∫≠t l·ªá", correct: false },
              ],
            },
            {
              question:
                "Vua n√†o ƒë√£ th·ª±c hi·ªán nhi·ªÅu c·∫£i c√°ch v√† ƒë∆∞a ƒë·∫•t n∆∞·ªõc ph√°t tri·ªÉn c·ª±c th·ªãnh th·ªùi L√™ S∆°?",
              options: [
                { text: "L√™ Th√°i T·ªï", correct: false },
                { text: "L√™ Th√°nh T√¥ng", correct: true },
                { text: "L√™ Nh√¢n T√¥ng", correct: false },
              ],
            },
          ],
          puzzles: [
            {
              instruction: "S·∫Øp x·∫øp c√°c m·ªëc l·ªãch s·ª≠:",
              pieces: [
                { text: "Kh·ªüi nghƒ©a Lam S∆°n", order: 1 },
                { text: "L√™ L·ª£i ƒëƒÉng quang", order: 2 },
                { text: "ƒê√°nh b·∫°i qu√¢n Minh", order: 3 },
              ],
            },
            {
              instruction: "S·∫Øp x·∫øp theo m·ªëi li√™n h·ªá:",
              pieces: [
                { text: "ƒê·ªÅ cao gi√°o d·ª•c", order: 1 },
                { text: "T·ªï ch·ª©c khoa thi", order: 2 },
                { text: "D·ª±ng Bia Ti·∫øn sƒ© (1484)", order: 3 },
              ],
            },
          ],
        },
        modern: {
          title: "Th·ªùi K·ª≥ Hi·ªán ƒê·∫°i (Th·∫ø k·ª∑ XX - Nay)",
          info: `
                    <p><strong>Th·ªùi gian:</strong> 1945 - Hi·ªán t·∫°i. Giai ƒëo·∫°n gi√†nh ƒë·ªôc l·∫≠p, th·ªëng nh·∫•t ƒë·∫•t n∆∞·ªõc v√† h·ªôi nh·∫≠p qu·ªëc t·∫ø.</p>
                    <p><strong>S·ª± ki·ªán:</strong> C√°ch m·∫°ng th√°ng T√°m 1945 v√† Tuy√™n ng√¥n ƒë·ªôc l·∫≠p, m·ªü ra k·ª∑ nguy√™n m·ªõi cho d√¢n t·ªôc. ƒê·ªânh cao l√† Chi·∫øn d·ªãch H·ªì Ch√≠ Minh l·ªãch s·ª≠ nƒÉm 1975, th·ªëng nh·∫•t ƒë·∫•t n∆∞·ªõc.</p>
                    <div class="heritage-item">
                        <strong>Di s·∫£n:</strong> Khu di t√≠ch Ho√†ng th√†nh ThƒÉng Long
                        <p>Khu di t√≠ch l·ªãch s·ª≠ v√† vƒÉn h√≥a quan tr·ªçng, l√† minh ch·ª©ng cho s·ª± ph√°t tri·ªÉn li√™n t·ª•c c·ªßa kinh ƒë√¥ Vi·ªát Nam qua nhi·ªÅu tri·ªÅu ƒë·∫°i (L√Ω, Tr·∫ßn, L√™, Nguy·ªÖn). ƒê∆∞·ª£c UNESCO c√¥ng nh·∫≠n Di s·∫£n Th·∫ø gi·ªõi nƒÉm 2010.</p>
                    </div>
                    <div class="heritage-item">
                        <strong>Di s·∫£n:</strong> Tinh th·∫ßn Y√™u n∆∞·ªõc v√† ƒê·ªôc l·∫≠p D√¢n t·ªôc
                        <p>Gi√° tr·ªã c·ªët l√µi ƒë∆∞·ª£c hun ƒë√∫c qua c√°c cu·ªôc kh√°ng chi·∫øn, th·ªÉ hi·ªán qua c√°c hi·ªán v·∫≠t l·ªãch s·ª≠, ngh·ªá thu·∫≠t ƒë∆∞∆°ng ƒë·∫°i v√† √Ω th·ª©c b·∫£o t·ªìn vƒÉn h√≥a trong th·ªùi k·ª≥ h·ªôi nh·∫≠p.</p>
                    </div>
                `,
          quizs: [
            {
              question:
                "Ho√†ng th√†nh ThƒÉng Long ƒë∆∞·ª£c UNESCO c√¥ng nh·∫≠n l√† Di s·∫£n Th·∫ø gi·ªõi v√†o nƒÉm n√†o?",
              options: [
                { text: "NƒÉm 2010", correct: true },
                { text: "NƒÉm 2000", correct: false },
                { text: "NƒÉm 2011", correct: false },
              ],
            },
            {
              question:
                "S·ª± ki·ªán n√†o ƒë√°nh d·∫•u s·ª± ch·∫•m d·ª©t ho√†n to√†n ch·∫ø ƒë·ªô phong ki·∫øn t·∫°i Vi·ªát Nam?",
              options: [
                { text: "Chi·∫øn d·ªãch ƒêi·ªán Bi√™n Ph·ªß", correct: false },
                { text: "C√°ch m·∫°ng th√°ng T√°m (1945)", correct: true },
                { text: "Hi·ªáp ƒë·ªãnh Geneva", correct: false },
              ],
            },
            {
              question:
                "ƒê·ªãa danh n√†o l√† bi·ªÉu t∆∞·ª£ng cho s·ª± ki·ªán gi·∫£i ph√≥ng mi·ªÅn Nam, th·ªëng nh·∫•t ƒë·∫•t n∆∞·ªõc nƒÉm 1975?",
              options: [
                { text: "Dinh ƒê·ªôc L·∫≠p", correct: true },
                { text: "Khu Ph·ªë C·ªï H·ªôi An", correct: false },
                { text: "ƒê·ªãa ƒë·∫°o C·ªß Chi", correct: false },
              ],
            },
          ],
          puzzles: [
            {
              instruction: "S·∫Øp x·∫øp th·ª© t·ª± c√°c m·ªëc l·ªãch s·ª≠:",
              pieces: [
                { text: "C√°ch m·∫°ng th√°ng T√°m (1945)", order: 1 },
                { text: "Chi·∫øn th·∫Øng ƒêi·ªán Bi√™n Ph·ªß (1954)", order: 2 },
                { text: "Th·ªëng nh·∫•t ƒë·∫•t n∆∞·ªõc (1975)", order: 3 },
              ],
            },
            {
              instruction: "S·∫Øp x·∫øp theo m·ªëi li√™n h·ªá:",
              pieces: [
                { text: "H·ªôi nh·∫≠p Qu·ªëc t·∫ø", order: 1 },
                { text: "Ph√°t huy VƒÉn h√≥a truy·ªÅn th·ªëng", order: 2 },
                { text: "Di s·∫£n Th·∫ø gi·ªõi", order: 3 },
              ],
            },
          ],
        },
      };

      // AI Responses
      const aiResponses = {
        greetings: [
          "Xin ch√†o Ng∆∞·ªùi B·∫£o V·ªá Di S·∫£n! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n trong h√†nh tr√¨nh b·∫£o v·ªá vƒÉn h√≥a Vi·ªát Nam?",
          "Ch√†o b·∫°n! C√πng nhau, ch√∫ng ta c√≥ th·ªÉ b·∫£o v·ªá di s·∫£n vƒÉn h√≥a Vi·ªát Nam kh·ªèi s·ª± l√£ng qu√™n.",
          "Xin ch√†o! H√£y h·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨ v·ªÅ l·ªãch s·ª≠ v√† di s·∫£n Vi·ªát Nam.",
        ],
        hungVuong: [
          "Th·ªùi ƒë·∫°i H√πng V∆∞∆°ng l√† th·ªùi k·ª≥ m·ªü ƒë·∫ßu cho l·ªãch s·ª≠ Vi·ªát Nam, k√©o d√†i t·ª´ kho·∫£ng th·∫ø k·ª∑ VII TCN ƒë·∫øn th·∫ø k·ª∑ III TCN.",
          "Theo truy·ªÅn thuy·∫øt, 18 ƒë·ªùi Vua H√πng ƒë√£ cai tr·ªã n∆∞·ªõc VƒÉn Lang - nh√† n∆∞·ªõc ƒë·∫ßu ti√™n c·ªßa ng∆∞·ªùi Vi·ªát.",
          "Th·ªùi k·ª≥ H√πng V∆∞∆°ng g·∫Øn li·ªÅn v·ªõi n·ªÅn vƒÉn h√≥a ƒê√¥ng S∆°n n·ªïi ti·∫øng v·ªõi tr·ªëng ƒë·ªìng v√† c√°c c√¥ng c·ª• b·∫±ng ƒë·ªìng.",
        ],
        bachDang: [
          "Ng√¥ Quy·ªÅn l√† v·ªã anh h√πng d√¢n t·ªôc ƒë√£ l√£nh ƒë·∫°o chi·∫øn th·∫Øng B·∫°ch ƒê·∫±ng nƒÉm 938, ch·∫•m d·ª©t h∆°n 1000 nƒÉm B·∫Øc thu·ªôc.",
          "Tr·∫≠n B·∫°ch ƒê·∫±ng nƒÉm 938 l√† m·ªôt trong nh·ªØng chi·∫øn th·∫Øng vƒ© ƒë·∫°i nh·∫•t trong l·ªãch s·ª≠ ch·ªëng ngo·∫°i x√¢m c·ªßa d√¢n t·ªôc Vi·ªát Nam.",
          "Ng√¥ Quy·ªÅn ƒë√£ d√πng k·∫ø c·∫Øm c·ªçc nh·ªçn tr√™n s√¥ng B·∫°ch ƒê·∫±ng ƒë·ªÉ ƒë√°nh b·∫°i qu√¢n Nam H√°n.",
        ],
        ly: [
          "L√Ω C√¥ng U·∫©n l√† ng∆∞·ªùi s√°ng l·∫≠p ra Nh√† L√Ω v√† ƒë√£ d·ªùi ƒë√¥ t·ª´ Hoa L∆∞ v·ªÅ ThƒÉng Long (H√† N·ªôi ng√†y nay) v√†o nƒÉm 1010.",
          "VƒÉn Mi·∫øu - Qu·ªëc T·ª≠ Gi√°m ƒë∆∞·ª£c x√¢y d·ª±ng d∆∞·ªõi th·ªùi L√Ω, l√† tr∆∞·ªùng ƒë·∫°i h·ªçc ƒë·∫ßu ti√™n c·ªßa Vi·ªát Nam.",
          "Nh√† L√Ω ƒë√£ m·ªü ra m·ªôt th·ªùi k·ª≥ ƒë·ªôc l·∫≠p, t·ª± ch·ªß v√† ph√°t tri·ªÉn vƒÉn h√≥a r·ª±c r·ª° cho d√¢n t·ªôc.",
        ],
        tran: [
          "Nh√† Tr·∫ßn n·ªïi ti·∫øng v·ªõi ba l·∫ßn kh√°ng chi·∫øn ch·ªëng qu√¢n Nguy√™n M√¥ng th·∫Øng l·ª£i, d∆∞·ªõi s·ª± l√£nh ƒë·∫°o c·ªßa H∆∞ng ƒê·∫°o V∆∞∆°ng Tr·∫ßn Qu·ªëc Tu·∫•n.",
          "Thi·ªÅn ph√°i Tr√∫c L√¢m Y√™n T·ª≠ ra ƒë·ªùi d∆∞·ªõi th·ªùi Tr·∫ßn, th·ªÉ hi·ªán s·ª± ph√°t tri·ªÉn ƒë·ªôc l·∫≠p c·ªßa Ph·∫≠t gi√°o Vi·ªát Nam.",
          "H·ªôi ngh·ªã Di√™n H·ªìng l√† bi·ªÉu t∆∞·ª£ng cho s·ª± ƒë·ªìng l√≤ng 'vua t√¥i ƒë·ªìng l√≤ng, anh em h√≤a thu·∫≠n' ch·ªëng ngo·∫°i x√¢m.",
        ],
        le: [
          "L√™ L·ª£i l√† ng∆∞·ªùi ƒë√£ gi·∫£i ph√≥ng ƒë·∫•t n∆∞·ªõc kh·ªèi √°ch ƒë√¥ h·ªô nh√† Minh, l·∫≠p ra Nh√† L√™ S∆°.",
          "Vua L√™ Th√°nh T√¥ng l√† ng∆∞·ªùi ƒë√£ ban h√†nh B·ªô lu·∫≠t H·ªìng ƒê·ª©c, b·ªô lu·∫≠t ti·∫øn b·ªô v√† to√†n di·ªán nh·∫•t trong l·ªãch s·ª≠ phong ki·∫øn Vi·ªát Nam.",
          "Truy·ªÅn th·ªëng hi·∫øu h·ªçc ƒë∆∞·ª£c ƒë·ªÅ cao qua vi·ªác d·ª±ng Bia Ti·∫øn sƒ© t·∫°i VƒÉn Mi·∫øu.",
        ],
        heritage: [
          "B·∫£o v·ªá di s·∫£n kh√¥ng ch·ªâ l√† g√¨n gi·ªØ qu√° kh·ª©, m√† l√† x√¢y d·ª±ng t∆∞∆°ng lai t·ª´ nh·ªØng gi√° tr·ªã c·ªët l√µi c·ªßa d√¢n t·ªôc.",
          "M·ªói di s·∫£n ƒë∆∞·ª£c b·∫£o v·ªá l√† m·ªôt c√¢u chuy·ªán ƒë∆∞·ª£c k·ªÉ l·∫°i, m·ªôt gi√° tr·ªã ƒë∆∞·ª£c truy·ªÅn trao cho th·∫ø h·ªá t∆∞∆°ng lai.",
          "Khi gi·ªõi tr·∫ª quan t√¢m ƒë·∫øn di s·∫£n, h·ªç kh√¥ng ch·ªâ h·ªçc v·ªÅ l·ªãch s·ª≠ m√† c√≤n t√¨m th·∫•y b·∫£n s·∫Øc v√† ni·ªÅm t·ª± h√†o d√¢n t·ªôc.",
        ],
        general: [
          "L·ªãch s·ª≠ Vi·ªát Nam tr·∫£i qua h√†ng ng√†n nƒÉm v·ªõi nhi·ªÅu thƒÉng tr·∫ßm nh∆∞ng lu√¥n gi·ªØ v·ªØng tinh th·∫ßn ƒë·ªôc l·∫≠p d√¢n t·ªôc.",
          "D√¢n t·ªôc Vi·ªát Nam c√≥ truy·ªÅn th·ªëng y√™u n∆∞·ªõc, b·∫•t khu·∫•t ch·ªëng ngo·∫°i x√¢m v√† x√¢y d·ª±ng ƒë·∫•t n∆∞·ªõc.",
          "VƒÉn h√≥a Vi·ªát Nam l√† s·ª± k·∫øt h·ª£p h√†i h√≤a gi·ªØa b·∫£n s·∫Øc d√¢n t·ªôc v√† ti·∫øp thu tinh hoa vƒÉn h√≥a nh√¢n lo·∫°i.",
        ],
      };

      // DOM Elements
      const screens = document.querySelectorAll(".screen");
      const loginScreen = document.getElementById("login-screen");
      const menuScreen = document.getElementById("menu-screen");
      const gameScreen = document.getElementById("game-screen");
      const impactScreen = document.getElementById("impact-screen");
      const summaryScreen = document.getElementById("summary-screen");

      const loginBtn = document.getElementById("login-btn");
      const startBtn = document.getElementById("start-btn");
      const impactBtn = document.getElementById("impact-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const backBtn = document.getElementById("back-btn");
      const backFromImpactBtn = document.getElementById("back-from-impact");
      const restartBtn = document.getElementById("restart-btn");
      const backToMenuSummary = document.getElementById("back-to-menu-summary");

      const playerNameInput = document.getElementById("player-name");
      const playerGreeting = document.getElementById("player-greeting");
      const playerSummaryName = document.getElementById("player-summary-name");
      const historySection = document.getElementById("history-section");
      const historyList = document.getElementById("history-list");

      const eraTitle = document.getElementById("era-title");
      const scoreElement = document.getElementById("score");
      const heritageCountElement = document.getElementById("heritage-count");
      const knowledgeElement = document.getElementById("knowledge");
      const eraInfo = document.getElementById("era-info");

      // Quiz Elements
      const quizQuestion = document.getElementById("quiz-question");
      const quizOptions = document.getElementById("quiz-options");
      const quizFeedback = document.getElementById("quiz-feedback");
      const nextQuizBtn = document.getElementById("next-quiz-btn");
      const quizProgress = document.getElementById("quiz-progress");

      // Puzzle Elements
      const preserveBtn = document.getElementById("preserve-btn");
      const puzzleSource = document.getElementById("puzzle-source");
      const puzzleTarget = document.getElementById("puzzle-target");
      const checkPuzzleBtn = document.getElementById("check-puzzle");
      const puzzleFeedback = document.getElementById("puzzle-feedback");
      const puzzleInstruction = document.getElementById("puzzle-instruction");
      const puzzleProgress = document.getElementById("puzzle-progress");

      // AI Elements
      const chatContainer = document.getElementById("chat-container");
      const userInput = document.getElementById("user-input");
      const sendBtn = document.getElementById("send-btn");

      const eraCards = document.querySelectorAll(".era-card");

      // Impact Elements
      const impactKnowledgeRing = document.getElementById(
        "impact-knowledge-ring"
      );
      const impactHeritageRing = document.getElementById(
        "impact-heritage-ring"
      );
      const impactYouthRing = document.getElementById("impact-youth-ring");
      const impactAwarenessRing = document.getElementById(
        "impact-awareness-ring"
      );
      const impactKnowledgeText = document.getElementById(
        "impact-knowledge-text"
      );
      const impactHeritageText = document.getElementById(
        "impact-heritage-text"
      );
      const impactYouthText = document.getElementById("impact-youth-text");
      const impactAwarenessText = document.getElementById(
        "impact-awareness-text"
      );

      // Summary Elements
      const finalScore = document.getElementById("final-score");
      const finalHeritageCount = document.getElementById(
        "final-heritage-count"
      );
      const finalKnowledge = document.getElementById("final-knowledge");
      const preservedList = document.getElementById("preserved-list");

      const notification = document.getElementById("notification");
      const notificationIcon = document.getElementById("notification-icon");
      const notificationText = document.getElementById("notification-text");

      // Game Initialization
      function initGame() {
        updateGameState();
        loadEra(gameState.currentEra);
        setupEventListeners();
        loadPlayerHistory();
      }

      // Event Listeners Setup
      function setupEventListeners() {
        loginBtn.onclick = handleLogin;
        startBtn.onclick = () => showScreen("game-screen");
        impactBtn.onclick = () =>
          document
            .getElementById("impact-screen")
            .scrollIntoView({ behavior: "smooth" });
        logoutBtn.onclick = handleLogout;

        backBtn.onclick = () =>
          document
            .getElementById("menu-screen")
            .scrollIntoView({ behavior: "smooth" });
        backFromImpactBtn.onclick = () =>
          document
            .getElementById("menu-screen")
            .scrollIntoView({ behavior: "smooth" });
        restartBtn.onclick = resetGame;
        backToMenuSummary.onclick = () =>
          document
            .getElementById("menu-screen")
            .scrollIntoView({ behavior: "smooth" });

        preserveBtn.onclick = preserveHeritage;
        checkPuzzleBtn.onclick = checkPuzzle;
        nextQuizBtn.onclick = nextQuiz;
        sendBtn.onclick = sendMessage;
        userInput.onkeypress = (e) => {
          if (e.key === "Enter") sendMessage();
        };

        eraCards.forEach((card) => {
          card.onclick = function () {
            const eraId = this.getAttribute("data-era");
            if (gameState.unlockedEras.includes(eraId)) {
              loadEra(eraId);
            } else {
              showNotification(
                "B·∫°n c·∫ßn ho√†n th√†nh th·ªùi k·ª≥ tr∆∞·ªõc ƒë·ªÉ m·ªü kh√≥a!",
                "warning"
              );
            }
          };
        });
      }

      // Login/Logout Functions
      function handleLogin() {
        const playerName = playerNameInput.value.trim();

        if (!playerName) {
          showNotification("Vui l√≤ng nh·∫≠p h·ªç v√† t√™n c·ªßa b·∫°n!", "error");
          return;
        }

        gameState.playerName = playerName;
        playerGreeting.textContent = playerName;
        playerSummaryName.textContent = playerName;

        showScreen("main-screen");
        showNotification(
          `Ch√†o m·ª´ng ${playerName} ƒë·∫øn v·ªõi h√†nh tr√¨nh b·∫£o v·ªá di s·∫£n!`,
          "success"
        );
      }

      function handleLogout() {
        savePlayerHistory();
        gameState.playerName = "";
        playerNameInput.value = "";
        showScreen("login-screen");
        showNotification("ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!", "success");
      }

      // Player History Management
      function savePlayerHistory() {
        if (!gameState.playerName) return;

        const playerHistory = {
          name: gameState.playerName,
          score: gameState.score,
          heritageCount: gameState.heritageCount,
          date: new Date().toLocaleDateString("vi-VN"),
          time: new Date().toLocaleTimeString("vi-VN"),
        };

        let history = JSON.parse(localStorage.getItem("playerHistory") || "[]");

        // Check if this player already has a history entry
        const existingIndex = history.findIndex(
          (entry) => entry.name === gameState.playerName
        );

        if (existingIndex !== -1) {
          // Update existing entry if current score is higher
          if (gameState.score > history[existingIndex].score) {
            history[existingIndex] = playerHistory;
          }
        } else {
          // Add new entry
          history.push(playerHistory);
        }

        // Keep only the last 10 entries
        if (history.length > 10) {
          history = history.slice(-10);
        }

        localStorage.setItem("playerHistory", JSON.stringify(history));
      }

      function loadPlayerHistory() {
        const history = JSON.parse(
          localStorage.getItem("playerHistory") || "[]"
        );

        if (history.length > 0) {
          historySection.style.display = "block";
          historyList.innerHTML = "";

          history.reverse().forEach((entry) => {
            const historyItem = document.createElement("div");
            historyItem.className = "heritage-item";
            historyItem.innerHTML = `
                        <strong>${entry.name}</strong> - ${entry.score} ƒëi·ªÉm - ${entry.heritageCount}/6 di s·∫£n<br>
                        <small>${entry.date} ${entry.time}</small>
                    `;
            historyList.appendChild(historyItem);
          });
        } else {
          historySection.style.display = "none";
        }
      }

      // Screen Management
      function showScreen(screenId) {
        screens.forEach((screen) => {
          screen.classList.remove("active");
        });

        if (screenId === "main-screen") {
          document.getElementById("main-screen").classList.add("active");
          document.getElementById("menu-screen").classList.add("active");
        } else if (
          screenId === "game-screen" ||
          screenId === "impact-screen" ||
          screenId === "summary-screen"
        ) {
          document.getElementById("main-screen").classList.add("active");
          document.getElementById(screenId).classList.add("active");
        } else {
          document.getElementById(screenId).classList.add("active");
        }

        if (screenId === "impact-screen") {
          updateImpactScreen();
        }
      }

      // Era Management
      function loadEra(eraId) {
        gameState.currentEra = eraId;
        const eraProgress = gameState.taskProgress[eraId];

        const era = eraData[eraId];
        eraTitle.textContent = era.title;
        eraInfo.innerHTML = era.info;

        // Update active/locked era cards
        eraCards.forEach((card) => {
          const cardEraId = card.getAttribute("data-era");
          if (cardEraId === eraId) {
            card.classList.add("active");
          } else {
            card.classList.remove("active");
          }

          if (!gameState.unlockedEras.includes(cardEraId)) {
            card.classList.add("locked");
          } else {
            card.classList.remove("locked");
          }
        });

        // Load tasks
        loadQuizTask(eraId);
        loadPuzzleTask(eraId);

        // Update preserve button
        updatePreserveButton();
      }

      // --- QUIZ LOGIC ---

      function loadQuizTask(eraId) {
        const era = eraData[eraId];
        const progress = gameState.taskProgress[eraId];
        const maxQuiz = era.quizs.length;
        const currentQuizCorrect = progress.quizCorrect;

        // Get current quiz index for display/loading
        const nextQuizIndex = currentQuizCorrect % maxQuiz;

        const minQuizCorrect = Math.ceil(maxQuiz * QUIZ_PASS_RATE);

        quizProgress.textContent = `Ti·∫øn ƒë·ªô: ${currentQuizCorrect}/${maxQuiz} c√¢u ƒë√∫ng (Y√™u c·∫ßu: ${minQuizCorrect} c√¢u)`;

        if (currentQuizCorrect >= minQuizCorrect) {
          quizQuestion.textContent =
            "‚úÖ ƒê√É HO√ÄN TH√ÄNH: B·∫°n ƒë√£ ƒë·∫°t ƒëi·ªÉm ƒë·ªÉ b·∫£o v·ªá Di s·∫£n!";
          quizOptions.innerHTML = "";
          quizFeedback.textContent = "";
          nextQuizBtn.style.display = "none";
          return;
        }

        const quiz = era.quizs[nextQuizIndex];

        quizQuestion.textContent = `C√¢u h·ªèi ${nextQuizIndex + 1}/${maxQuiz}: ${
          quiz.question
        }`;
        quizOptions.innerHTML = "";
        quizFeedback.textContent = "Ch·ªçn c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:";
        nextQuizBtn.style.display = "none";

        quiz.options.forEach((option) => {
          const optionElement = document.createElement("div");
          optionElement.className = "quiz-option";
          optionElement.textContent = option.text;
          optionElement.setAttribute("data-correct", option.correct);

          optionElement.addEventListener("click", () =>
            checkAnswer(optionElement)
          );
          quizOptions.appendChild(optionElement);
        });
      }

      function checkAnswer(selectedOption) {
        // Check if any option is already selected/answered for this question
        if (quizOptions.querySelector(".answered")) return;

        const isCorrect =
          selectedOption.getAttribute("data-correct") === "true";
        const eraId = gameState.currentEra;

        // Mark all options as answered (disable click)
        quizOptions
          .querySelectorAll(".quiz-option")
          .forEach((opt) => opt.classList.add("answered"));

        if (isCorrect) {
          selectedOption.classList.add("correct");
          quizFeedback.textContent = "Ch√≠nh x√°c! +10 ƒëi·ªÉm.";
          quizFeedback.style.color = "green";

          gameState.score += 10;
          gameState.socialImpact.knowledgeRestored += 5;
          gameState.knowledge += 5;

          // Increase correct count, capping at max questions
          gameState.taskProgress[eraId].quizCorrect = Math.min(
            eraData[eraId].quizs.length,
            gameState.taskProgress[eraId].quizCorrect + 1
          );
          showNotification(
            "Ch√≠nh x√°c! Ki·∫øn th·ª©c l·ªãch s·ª≠ ƒë∆∞·ª£c kh√¥i ph·ª•c",
            "success"
          );
        } else {
          selectedOption.classList.add("incorrect");
          quizFeedback.textContent = "Ch∆∞a ch√≠nh x√°c. H√£y h·ªçc l·∫°i v√† th·ª≠ l·∫°i!";
          quizFeedback.style.color = "red";

          const correctOption = quizOptions.querySelector(
            '.quiz-option[data-correct="true"]'
          );
          correctOption.classList.add("correct");

          showNotification("H√£y h·ªçc l·∫°i v√† th·ª≠ l·∫°i!", "error");
        }

        // Display next button if not already completed
        const maxQuiz = eraData[eraId].quizs.length;
        const minQuizCorrect = Math.ceil(maxQuiz * QUIZ_PASS_RATE);
        if (gameState.taskProgress[eraId].quizCorrect < minQuizCorrect) {
          nextQuizBtn.style.display = "block";
        }

        updateGameState();
        updatePreserveButton();
      }

      function nextQuiz() {
        const eraId = gameState.currentEra;
        const currentEraData = eraData[eraId];
        const progress = gameState.taskProgress[eraId];

        // Reload the task, which automatically loads the next question based on current progress
        loadQuizTask(eraId);
      }

      // --- PUZZLE LOGIC ---

      function loadPuzzleTask(eraId) {
        const era = eraData[eraId];
        const progress = gameState.taskProgress[eraId];
        const maxPuzzle = era.puzzles.length;
        const currentPuzzleCompleted = progress.puzzleCompleted;

        const minPuzzleCompleted = Math.ceil(maxPuzzle * PUZZLE_PASS_RATE);

        puzzleProgress.textContent = `Ti·∫øn ƒë·ªô: ${currentPuzzleCompleted}/${maxPuzzle} nhi·ªám v·ª• (Y√™u c·∫ßu: ${minPuzzleCompleted} nhi·ªám v·ª•)`;
        checkPuzzleBtn.disabled = false;

        if (currentPuzzleCompleted >= minPuzzleCompleted) {
          puzzleInstruction.innerHTML =
            "‚úÖ ƒê√É HO√ÄN TH√ÄNH: B·∫°n ƒë√£ ƒë·∫°t ƒëi·ªÉm ƒë·ªÉ b·∫£o v·ªá Di s·∫£n!";
          puzzleFeedback.textContent = "";
          puzzleSource.innerHTML = "";
          puzzleTarget.innerHTML = "";
          checkPuzzleBtn.disabled = true;
          return;
        }

        const index = currentPuzzleCompleted % maxPuzzle;
        const puzzle = era.puzzles[index];

        puzzleInstruction.innerHTML = `<p><strong>Nhi·ªám v·ª• ${
          currentPuzzleCompleted + 1
        }/${maxPuzzle}:</strong> ${puzzle.instruction}</p>`;
        puzzleSource.innerHTML = "";
        puzzleTarget.innerHTML =
          '<div class="placeholder">K√©o c√°c s·ª± ki·ªán v√†o ƒë√¢y</div>';
        puzzleFeedback.textContent =
          "S·∫Øp x·∫øp c√°c m·∫£nh gh√©p v√†o khung b√™n tr√°i.";

        // Shuffle and load pieces
        const shuffledPieces = [...puzzle.pieces].sort(
          () => Math.random() - 0.5
        );
        shuffledPieces.forEach((piece) => {
          puzzleSource.appendChild(createPuzzlePiece(piece));
        });

        // Set up drag/drop listeners
        setupDropZone();
      }

      function checkPuzzle() {
        const eraId = gameState.currentEra;
        const era = eraData[eraId];
        const currentPuzzleIndex =
          gameState.taskProgress[eraId].puzzleCompleted % era.puzzles.length;

        const piecesInTarget = Array.from(
          puzzleTarget.querySelectorAll(".puzzle-piece")
        );
        const totalPieces = era.puzzles[currentPuzzleIndex].pieces.length;

        // Reset piece visuals
        piecesInTarget.forEach((p) =>
          p.classList.remove("correct", "incorrect")
        );

        if (piecesInTarget.length < totalPieces) {
          puzzleFeedback.textContent = `H√£y k√©o ƒë·ªß ${totalPieces} s·ª± ki·ªán v√†o khung!`;
          puzzleFeedback.style.color = "red";
          return;
        }

        let correct = true;

        piecesInTarget.forEach((piece, index) => {
          const pieceOrder = parseInt(piece.getAttribute("data-order"));
          const expectedOrder = index + 1;

          // Remove previous feedback classes
          piece.classList.remove("correct", "incorrect");

          if (pieceOrder === expectedOrder) {
            piece.classList.add("correct");
          } else {
            piece.classList.add("incorrect");
            correct = false;
          }
        });

        if (correct) {
          puzzleFeedback.textContent =
            "Ho√†n h·∫£o! +15 ƒëi·ªÉm. B·∫°n ƒë√£ ho√†n th√†nh nhi·ªám v·ª• n√†y.";
          puzzleFeedback.style.color = "green";

          gameState.score += 15;
          gameState.socialImpact.knowledgeRestored += 8;
          gameState.knowledge += 8;

          // Advance puzzle progress and reload next puzzle
          gameState.taskProgress[eraId].puzzleCompleted++;
          loadPuzzleTask(eraId);

          showNotification("Xu·∫•t s·∫Øc! B·∫°n ƒë√£ s·∫Øp x·∫øp ƒë√∫ng l·ªãch s·ª≠", "success");
        } else {
          puzzleFeedback.textContent =
            "Th·ª© t·ª± ch∆∞a ch√≠nh x√°c. H√£y s·∫Øp x·∫øp l·∫°i!";
          puzzleFeedback.style.color = "red";

          // Re-enable dragging for all pieces in target for re-arranging
          piecesInTarget.forEach((p) => p.setAttribute("draggable", "true"));
        }

        updateGameState();
        updatePreserveButton();
      }

      // Helper functions for Puzzle (createPiece, setupDropZone, handleDrop)
      function createPuzzlePiece(piece) {
        const pieceElement = document.createElement("div");
        pieceElement.className = "puzzle-piece";
        pieceElement.textContent = piece.text;
        pieceElement.setAttribute("draggable", "true");
        pieceElement.setAttribute("data-order", piece.order);

        pieceElement.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", piece.order);
          pieceElement.classList.add("dragging");
        });

        pieceElement.addEventListener("dragend", () => {
          pieceElement.classList.remove("dragging");
        });
        return pieceElement;
      }

      function setupDropZone() {
        // Remove old listeners to prevent duplication
        puzzleTarget.removeEventListener("dragover", preventDefault);
        puzzleTarget.removeEventListener("drop", handleTargetDrop);
        puzzleSource.removeEventListener("dragover", preventDefault);
        puzzleSource.removeEventListener("drop", handleSourceDrop);

        // Add new listeners
        puzzleTarget.addEventListener("dragover", preventDefault);
        puzzleTarget.addEventListener("drop", handleTargetDrop);
        puzzleSource.addEventListener("dragover", preventDefault);
        puzzleSource.addEventListener("drop", handleSourceDrop);
      }

      function preventDefault(e) {
        e.preventDefault();
      }

      function handleTargetDrop(e) {
        e.preventDefault();
        const order = e.dataTransfer.getData("text/plain");
        const piece = document.querySelector(
          `.puzzle-piece[data-order="${order}"]`
        );

        if (piece && piece.parentElement !== puzzleTarget) {
          // Ensure correct piece style/dragability is maintained for re-ordering
          piece.classList.remove("correct", "incorrect");
          piece.setAttribute("draggable", "true");
          puzzleTarget.appendChild(piece);
          const placeholder = puzzleTarget.querySelector(".placeholder");
          if (placeholder) placeholder.remove();
        }
      }

      function handleSourceDrop(e) {
        e.preventDefault();
        const order = e.dataTransfer.getData("text/plain");
        const piece = document.querySelector(
          `.puzzle-piece[data-order="${order}"]`
        );

        if (piece && piece.parentElement !== puzzleSource) {
          piece.classList.remove("correct", "incorrect"); // Reset visual
          puzzleSource.appendChild(piece);
          if (puzzleTarget.children.length === 0) {
            puzzleTarget.innerHTML =
              '<div class="placeholder">K√©o c√°c s·ª± ki·ªán v√†o ƒë√¢y</div>';
          }
        }
      }

      // --- GLOBAL MECHANICS ---

      function checkEraCompletion() {
        const eraId = gameState.currentEra;
        const eraDataCurrent = eraData[eraId];
        const progress = gameState.taskProgress[eraId];

        const minQuizCorrect = Math.ceil(
          eraDataCurrent.quizs.length * QUIZ_PASS_RATE
        );
        const minPuzzleCompleted = Math.ceil(
          eraDataCurrent.puzzles.length * PUZZLE_PASS_RATE
        );

        const isQuizComplete = progress.quizCorrect >= minQuizCorrect;
        const isPuzzleComplete = progress.puzzleCompleted >= minPuzzleCompleted;

        return isQuizComplete && isPuzzleComplete;
      }

      function preserveHeritage() {
        const currentEra = gameState.currentEra;

        if (!checkEraCompletion()) {
          showNotification(
            "B·∫°n c·∫ßn ho√†n th√†nh √≠t nh·∫•t 70% c√°c nhi·ªám v·ª• (Quiz v√† Puzzle) tr∆∞·ªõc khi b·∫£o v·ªá di s·∫£n!",
            "warning"
          );
          return;
        }

        if (!gameState.preservedHeritages.includes(currentEra)) {
          gameState.preservedHeritages.push(currentEra);
          gameState.heritageCount = gameState.preservedHeritages.length;
          gameState.score += 20;
          gameState.socialImpact.heritagePreserved += 15;
          gameState.socialImpact.culturalAwareness += 10;
          gameState.socialImpact.youthEngagement += 5;

          updatePreserveButton();
          updateGameState();

          showNotification(
            `Di s·∫£n ${eraData[currentEra].title} ƒë√£ ƒë∆∞·ª£c b·∫£o v·ªá!`,
            "success"
          );
          unlockNextEra();
        }
      }

      function updatePreserveButton() {
        const isEraComplete = checkEraCompletion();
        const isPreserved = gameState.preservedHeritages.includes(
          gameState.currentEra
        );

        if (isPreserved) {
          preserveBtn.textContent = "ƒê√£ B·∫£o V·ªá ‚úÖ";
          preserveBtn.disabled = true;
          preserveBtn.style.background = "#4CAF50";
          preserveBtn.style.boxShadow = "0 3px 0 #1B5E20";
        } else if (isEraComplete) {
          preserveBtn.textContent = "B·∫¢O V·ªÜ DI S·∫¢N (ƒê·ªß ƒëi·ªÅu ki·ªán)";
          preserveBtn.disabled = false;
          // S·ª≠ d·ª•ng l·∫°i m√†u Primary v√† Dark (ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a b·∫±ng bi·∫øn CSS)
          preserveBtn.style.background = getComputedStyle(
            document.documentElement
          )
            .getPropertyValue("--primary")
            .trim();
          preserveBtn.style.boxShadow =
            "0 6px 0 " +
            getComputedStyle(document.documentElement)
              .getPropertyValue("--dark")
              .trim();
        } else {
          preserveBtn.textContent = `B·∫£o V·ªá Di S·∫£n (Thi·∫øu nhi·ªám v·ª•)`;
          preserveBtn.disabled = true;
          preserveBtn.style.background = "#9E9E9E";
          preserveBtn.style.boxShadow = "0 3px 0 #616161";
        }
      }

      function unlockNextEra() {
        const eras = Object.keys(eraData);
        const currentIndex = eras.indexOf(gameState.currentEra);

        if (gameState.preservedHeritages.length === eras.length) {
          savePlayerHistory();
          showSummaryScreen();
          return;
        }

        if (currentIndex < eras.length - 1) {
          const nextEra = eras[currentIndex + 1];
          if (!gameState.unlockedEras.includes(nextEra)) {
            gameState.unlockedEras.push(nextEra);

            eraCards.forEach((card) => {
              if (card.getAttribute("data-era") === nextEra) {
                card.classList.remove("locked");
              }
            });

            showNotification(
              `Ch√∫c m·ª´ng! B·∫°n ƒë√£ m·ªü kh√≥a: ${eraData[nextEra].title}. H√£y chuy·ªÉn sang th·ªùi k·ª≥ m·ªõi.`,
              "success"
            );
            loadEra(nextEra);
          }
        }
      }

      // --- AI Chat System ---

      // --- AI Chat System ---

      // C·∫•u h√¨nh API cho Azure OpenAI
      const AI_CONFIG = {
        apiKey:
          "EOd81yMG8zL8My7IRsBuBT9Z3iBMkL51KBTJ4xba6l5MWYguNnHBJQQJ99BJACYeBjFXJ3w3AAABACOGb1Yy",
        apiUrl:
          "https://rmit-hackathon-ve.openai.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-02-15-preview",
        deploymentName: "gpt-35-turbo", // T√™n deployment model c·ªßa b·∫°n
        apiVersion: "2024-02-15-preview",
      };

      async function sendMessage() {
        const message = userInput.value.trim();
        if (message === "") return;

        addMessageToChat(message, "user");
        userInput.value = "";

        // Disable input while processing
        userInput.disabled = true;
        sendBtn.disabled = true;

        // Hi·ªÉn th·ªã indicator ƒëang g√µ
        const typingIndicator = addTypingIndicator();

        try {
          const aiResponse = await getAIResponse(message);
          removeTypingIndicator(typingIndicator);
          addMessageToChat(aiResponse, "ai");

          gameState.socialImpact.culturalAwareness += 1;
          updateGameState();
        } catch (error) {
          removeTypingIndicator(typingIndicator);
          console.error("AI Response Error:", error);
          // Fallback to local responses if API fails
          const fallbackResponse = generateAIResponse(message);
          addMessageToChat(fallbackResponse, "ai");
        } finally {
          // Re-enable input
          userInput.disabled = false;
          sendBtn.disabled = false;
          userInput.focus();
        }
      }

      async function getAIResponse(userMessage) {
        const currentEraId = gameState.currentEra;
        const currentEraData = eraData[currentEraId];

        // T·∫°o context cho AI v·ªÅ th·ªùi k·ª≥ hi·ªán t·∫°i
        const context = `B·∫°n l√† tr·ª£ l√Ω AI chuy√™n v·ªÅ l·ªãch s·ª≠ v√† di s·∫£n vƒÉn h√≥a Vi·ªát Nam. 
Ng∆∞·ªùi d√πng ƒëang t√¨m hi·ªÉu v·ªÅ ${currentEraData.title}.

Th√¥ng tin v·ªÅ th·ªùi k·ª≥ n√†y:
${currentEraData.info.replace(/<[^>]*>/g, "")}

H√£y tr·∫£ l·ªùi c√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng m·ªôt c√°ch ng·∫Øn g·ªçn, d·ªÖ hi·ªÉu v√† li√™n quan ƒë·∫øn di s·∫£n vƒÉn h√≥a Vi·ªát Nam.
S·ª≠ d·ª•ng ti·∫øng Vi·ªát v√† gi·ªØ c√¢u tr·∫£ l·ªùi trong kho·∫£ng 1-2 c√¢u.`;

        const requestBody = {
          messages: [
            {
              role: "system",
              content: context,
            },
            {
              role: "user",
              content: userMessage,
            },
          ],
          max_tokens: 150,
          temperature: 0.7,
          top_p: 0.9,
          frequency_penalty: 0,
          presence_penalty: 0,
        };

        const response = await fetch(AI_CONFIG.apiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "api-key": AI_CONFIG.apiKey, // Azure s·ª≠ d·ª•ng "api-key" thay v√¨ "Authorization"
          },
          body: JSON.stringify(requestBody),
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error("API Error Details:", errorText);
          throw new Error(`API Error: ${response.status} - ${errorText}`);
        }

        const data = await response.json();

        if (data.choices && data.choices.length > 0) {
          return data.choices[0].message.content.trim();
        } else {
          throw new Error("No response from AI");
        }
      }

      function addTypingIndicator() {
        const typingElement = document.createElement("div");
        typingElement.className = "message ai-message typing-indicator";
        typingElement.innerHTML = `
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        `;
        chatContainer.appendChild(typingElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return typingElement;
      }

      function removeTypingIndicator(indicator) {
        if (indicator && indicator.parentNode) {
          indicator.parentNode.removeChild(indicator);
        }
      }

      function addMessageToChat(message, sender) {
        const messageElement = document.createElement("div");
        messageElement.className = `message ${sender}-message`;
        messageElement.textContent = message;
        chatContainer.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // Gi·ªØ l·∫°i h√†m generateAIResponse nh∆∞ fallback
      function generateAIResponse(userMessage) {
        const lowerMessage = userMessage.toLowerCase();
        const currentEraId = gameState.currentEra;
        const currentEraData = eraData[currentEraId];

        if (
          lowerMessage.includes(currentEraData.title.toLowerCase()) ||
          lowerMessage.includes(currentEraId.toLowerCase()) ||
          lowerMessage.includes("th·ªùi k·ª≥ n√†y") ||
          lowerMessage.includes("di s·∫£n hi·ªán t·∫°i")
        ) {
          const heritageItems = currentEraData.info.match(
            /<strong>Di s·∫£n:<\/strong>(.*?)<p>/g
          );
          let response = `Th·ªùi k·ª≥ ${currentEraData.title} c√≥ nhi·ªÅu di s·∫£n quan tr·ªçng. N·ªïi b·∫≠t l√†: `;
          if (heritageItems) {
            response += heritageItems.map((m) =>
              m
                .replace(/<\/?strong>Di s·∫£n:<\/strong>/g, "")
                .replace(/<p>/g, "")
                .trim()
            )[0];
            if (heritageItems.length > 1) {
              response += ` v√† ${
                heritageItems.map((m) =>
                  m
                    .replace(/<\/?strong>Di s·∫£n:<\/strong>/g, "")
                    .replace(/<p>/g, "")
                    .trim()
                )[1]
              }.`;
            } else {
              response += `.`;
            }
          } else {
            response += `B·∫°n c√≥ th·ªÉ t√¨m hi·ªÉu chi ti·∫øt h∆°n trong ph·∫ßn "Th√¥ng Tin Th·ªùi K·ª≥".`;
          }
          return response;
        }

        if (
          lowerMessage.includes("ch√†o") ||
          lowerMessage.includes("xin ch√†o")
        ) {
          return getRandomResponse(aiResponses.greetings);
        } else if (
          lowerMessage.includes("h√πng v∆∞∆°ng") ||
          lowerMessage.includes("vua h√πng")
        ) {
          return getRandomResponse(aiResponses.hungVuong);
        } else if (
          lowerMessage.includes("b·∫°ch ƒë·∫±ng") ||
          lowerMessage.includes("ng√¥ quy·ªÅn")
        ) {
          return getRandomResponse(aiResponses.bachDang);
        } else if (
          lowerMessage.includes("l√Ω") ||
          lowerMessage.includes("thƒÉng long")
        ) {
          return getRandomResponse(aiResponses.ly);
        } else if (
          lowerMessage.includes("tr·∫ßn") ||
          lowerMessage.includes("ƒë√¥ng a")
        ) {
          return getRandomResponse(aiResponses.tran);
        } else if (
          lowerMessage.includes("l√™") ||
          lowerMessage.includes("h·ªìng ƒë·ª©c")
        ) {
          return getRandomResponse(aiResponses.le);
        } else if (
          lowerMessage.includes("di s·∫£n") ||
          lowerMessage.includes("b·∫£o v·ªá") ||
          lowerMessage.includes("b·∫£o t·ªìn")
        ) {
          return getRandomResponse(aiResponses.heritage);
        } else {
          return getRandomResponse(aiResponses.general);
        }
      }

      function getRandomResponse(responses) {
        const randomIndex = Math.floor(Math.random() * responses.length);
        return responses[randomIndex];
      }

      // --- UI / STATE UPDATES ---

      function showNotification(message, type) {
        notificationText.textContent = message;

        switch (type) {
          case "success":
            notificationIcon.textContent = "‚úÖ";
            notification.className = "notification success";
            break;
          case "error":
            notificationIcon.textContent = "‚ùå";
            notification.className = "notification error";
            break;
          case "warning":
            notificationIcon.textContent = "‚ö†Ô∏è";
            notification.className = "notification warning";
            break;
          default:
            notificationIcon.textContent = "‚ÑπÔ∏è";
            notification.className = "notification";
        }

        notification.classList.add("show");

        setTimeout(() => {
          notification.classList.remove("show");
        }, 3000);
      }

      function updateGameState() {
        const maxEras = Object.keys(eraData).length;

        // Calculate total max knowledge points (13 points * 6 eras = 78)
        const maxKnowledgePoints = maxEras * (5 + 8);

        // Calculate current knowledge percentage
        const currentKnowledgePercent = Math.min(
          100,
          Math.round((gameState.knowledge / maxKnowledgePoints) * 100)
        );

        scoreElement.textContent = gameState.score;
        heritageCountElement.textContent = `${gameState.heritageCount}/${maxEras}`;
        knowledgeElement.textContent = `${currentKnowledgePercent}%`;

        if (impactScreen.classList.contains("active")) {
          updateImpactScreen();
        }
      }

      function updateImpactScreen() {
        const maxEras = Object.keys(eraData).length;
        const knowledgePercent = Math.min(
          100,
          Math.round(
            (gameState.socialImpact.knowledgeRestored / (maxEras * 13)) * 100
          )
        );
        const heritagePercent = Math.min(
          100,
          Math.round(
            (gameState.socialImpact.heritagePreserved / (maxEras * 15)) * 100
          )
        );
        const youthPercent = Math.min(
          100,
          Math.round(
            (gameState.socialImpact.youthEngagement / (maxEras * 5)) * 100
          )
        );
        const awarenessPercent = Math.min(
          100,
          Math.round(
            (gameState.socialImpact.culturalAwareness / (maxEras * 10)) * 100
          )
        );

        updateProgressRing(impactKnowledgeRing, knowledgePercent);
        updateProgressRing(impactHeritageRing, heritagePercent);
        updateProgressRing(impactYouthRing, youthPercent);
        updateProgressRing(impactAwarenessRing, awarenessPercent);

        impactKnowledgeText.textContent = `${knowledgePercent}%`;
        impactHeritageText.textContent = `${heritagePercent}%`;
        impactYouthText.textContent = `${youthPercent}%`;
        impactAwarenessText.textContent = `${awarenessPercent}%`;
      }

      function updateProgressRing(ring, percent) {
        const circumference = 314;
        const offset = circumference - (percent / 100) * circumference;
        ring.style.strokeDashoffset = offset;
      }

      function showSummaryScreen() {
        showScreen("summary-screen");

        const maxEras = Object.keys(eraData).length;
        const maxKnowledgePoints = maxEras * 13;
        const knowledgePercent = Math.min(
          100,
          Math.round((gameState.knowledge / maxKnowledgePoints) * 100)
        );

        finalScore.textContent = gameState.score;
        finalHeritageCount.textContent = `${gameState.heritageCount}/${maxEras}`;
        finalKnowledge.textContent = `${knowledgePercent}%`;

        preservedList.innerHTML = "";
        gameState.preservedHeritages.forEach((eraId) => {
          const era = eraData[eraId];
          const listItem = document.createElement("li");
          const heritageText = era.info
            .match(/<strong>Di s·∫£n:<\/strong>(.*?)<p>/g)
            .map((m) =>
              m
                .replace(/<\/?strong>Di s·∫£n:<\/strong>/g, "")
                .replace(/<p>/g, "")
                .trim()
            )[0];
          listItem.innerHTML = `<strong>${era.title}:</strong> ${heritageText}...`;
          preservedList.appendChild(listItem);
        });
      }

      function resetGame() {
        gameState.score = 100;
        gameState.heritageCount = 0;
        gameState.knowledge = 0;
        gameState.currentEra = "hungVuong";
        gameState.unlockedEras = ["hungVuong"];
        gameState.preservedHeritages = [];
        gameState.taskProgress = {
          hungVuong: { quizCorrect: 0, puzzleCompleted: 0 },
          bachDang: { quizCorrect: 0, puzzleCompleted: 0 },
          ly: { quizCorrect: 0, puzzleCompleted: 0 },
          tran: { quizCorrect: 0, puzzleCompleted: 0 },
          le: { quizCorrect: 0, puzzleCompleted: 0 },
          modern: { quizCorrect: 0, puzzleCompleted: 0 },
        };
        gameState.socialImpact = {
          knowledgeRestored: 0,
          heritagePreserved: 0,
          youthEngagement: 0,
          culturalAwareness: 0,
        };

        eraCards.forEach((card) => {
          const eraId = card.getAttribute("data-era");
          card.classList.remove("active");
          if (eraId !== "hungVuong") {
            card.classList.add("locked");
          }
        });

        initGame();
        showScreen("menu-screen");
      }

      // Initialize the game
      initGame();
    </script>
  </body>
</html>
